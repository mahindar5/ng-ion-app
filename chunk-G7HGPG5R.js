import{a as f,b as w,c as M}from"./chunk-3GJFFWBB.js";var V=new Map;function u(e,t=[],a){let r=a||e.name;if(V.has(r))return V.get(r);let i=new e(...t);return V.set(r,i),i}var oe="pjgheakmmcejmgdoojlnjbgbafjoiedg",Qe=class{handleResponse(e){if(chrome.runtime.lastError)throw new Error(chrome.runtime.lastError.message);if(e.error||e.errorMessage||e.message||!e.success){let t=new Error(e.errorMessage||e.message||"Unknown error");if(e.error){let a=JSON.parse(e.error);t=new Error(a.message||"Unknown error"),t.stack=a.stack}throw t}return e}async sendMessageAwait(e,t,a){let r={helper:e,action:t,inputs:a},i=await chrome.runtime.sendMessage(oe,r);return this.handleResponse(i)}async sendMessageCallback(e,t,a){let r={helper:e,action:t,inputs:a};return new Promise((i,s)=>{chrome.runtime.sendMessage(oe,r,o=>{try{i(this.handleResponse(o))}catch(n){s(n)}})})}};var ne=async(e,t,a)=>u(Qe).sendMessageCallback(e,t,a),z=async(e,t,a)=>ne(e,t,a);var Ye=()=>{let e=window.fetch;window.fetch=async(t,a)=>{if(new Headers(a?.headers).get("my-org-extension")){let r=typeof t=="string"?t:t instanceof URL?t.href:t.url;a&&a.headers&&(a.headers instanceof Headers?a.headers.delete("my-org-extension"):Array.isArray(a.headers)?a.headers=a.headers.filter(([l])=>l.toLowerCase()!=="my-org-extension"):typeof a.headers=="object"&&a.headers!==null&&delete a.headers["my-org-extension"]);let i=await z("FetchHelper","fetch",{url:r,options:a}),s,o=i.output.headers?.["Content-Type"]||i.output.headers?.["content-type"]||"application/json";o=o.trim().toLowerCase();let n=i.output.headers?.["Content-Length"]||i.output.headers?.["content-length"];return n&&parseInt(n)===0?s=null:o.includes("application/x-www-form-urlencoded")?s=new URLSearchParams(i.output.body).toString():o.includes("application/xml")||o.includes("text/xml")?s=new DOMParser().parseFromString(i.output.body,"text/xml"):o.includes("application/json")?s=JSON.stringify(i.output.body):o.includes("text/")?s=i.output.body:o.includes("application/octet-stream")||o.includes("multipart/form-data")?s=atob(i.output.body):s=i.output.body,new Response(s,{status:i.output.status||200,statusText:i.output.statusText||"OK",headers:i.output.headers||{"Content-Type":o},url:i.output.url})}else return e(t,a)}};function le(e,t,a,r){t[e]=t[e]||new Map,t[e].set(a,r)}function A(e,t,a){le(A.name,e,t,a)}function E(e,t,a){le(E.name,e,t,a)}function O(e,t,a){let r=O.name;e[r]=e[r]||new Map;let i=e[r],s=i.get(t)||[];i.set(t,[...s,a])}var ce=1728e5,T=365*24*60*60*1e3,k=class{constructor(e){this.service=e}async setItem(e,t,a="none",r=ce,i=!0){if(t==null||typeof t=="string"&&!t.trim()||Array.isArray(t)&&t.length===0){console.error(`key: ${e}, value: ${JSON.stringify(t)}: Invalid Data. Cannot save it`);return}let s=Date.now()+r,o=r>T-1,n=i?JSON.stringify({value:t,expires:s,groupKey:a,persist:o}):{value:t,expires:s,groupKey:a,persist:o};await this.service.setItem(e,n)}async removeItem(e){await this.service.removeItem(e)}async getItem(e,t=!0){let a=await this.service.getItem(e);if(!a)return;let r=t?JSON.parse(a):a;if(r.expires>=Date.now())return r.value;r.persist||await this.removeItem(e)}async getOrLoadItem(e,t,a=!1,r="none",i=ce){if(!a){let o=await this.getItem(e);if(o!==void 0)return o}let s=await t();return await this.setItem(e,s,r,i),s}};function _(e){return function(t,a,r){let i=r.value;r.value=async function(...s){let{cacheService:o,groupKey:n,ttl:l}=e,c=t[A.name]?.get(a),p=e?.keyName??(typeof c=="number"?s[c]:void 0);if(!p)throw new Error("InstanceCacheLoader decorator: Please provide keyName either in params or as a method argument.");let y=t[E.name]?.get(a),d=e?.forceUpdate??(typeof y=="number"?s[y]:void 0);return d=typeof d=="boolean"?d:!1,o.getOrLoadItem(p,()=>i.apply(this,s),d,n,l)}}}var pe=class{async setItem(e,t){localStorage.setItem(e,t)}async removeItem(e){localStorage.removeItem(e)}async getItem(e){return localStorage.getItem(e)}};var g=u(k,[u(pe)],"localStorageService");function Ze(e){return _(w(f({},e),{cacheService:g}))}function G(e,t){let a,r,i=[];for(a=0,r=e.length;a<r;a+=t)i.push(e.slice(a,a+t));return i}function Q(e,t){return e.reduce((a,r)=>a.set(t.map(i=>r[i]).join("|"),[...a.get(t.map(i=>r[i]).join("|"))||[],r]),new Map)}function Y(e,t){let a={};return e.forEach(r=>{let i=a;t.forEach((s,o)=>{let n=r[s];i[n]||(i[n]=o===t.length-1?[]:{}),i=i[n]}),Array.isArray(i)&&i.push(r)}),a}function h(e,t=2){let a=parseFloat(e?.toFixed(t));return isNaN(a)||!isFinite(a)?null:a}function Xe(e,t){return Object.entries(t).find(([,a])=>typeof a=="string"&&typeof e=="string"?a.toLowerCase()===e.toLowerCase():a===e)?.[0]}var de=`query FetchActivityFeedItems($first: Int, $cursor: Cursor, $condition: ActivityCondition, $orderBy: [ActivitiesOrderBy!] = OCCURRED_AT_DESC) {
				activityFeedItems(
					first: $first
					after: $cursor
					condition: $condition
					orderBy: $orderBy
				) {
					edges {
						node {
							accountId
							aftOriginatorName
							aftTransactionCategory
							aftTransactionType
							amount
							amountSign
							assetQuantity
							assetSymbol
							canonicalId
							currency
							eTransferEmail
							eTransferName
							externalCanonicalId
							identityId
							institutionName
							occurredAt
							p2pHandle
							p2pMessage
							spendMerchant
							securityId
							billPayCompanyName
							billPayPayeeNickname
							redactedExternalAccountNumber
							opposingAccountId
							status
							subType
							type
							strikePrice
							contractType
							expiryDate
							chequeNumber
							provisionalCreditAmount
							primaryBlocker
							interestRate
							frequency
							counterAssetSymbol
							rewardProgram
							counterPartyCurrency
							counterPartyCurrencyAmount
							counterPartyName
							fxRate
							fees
							reference
							transferType
							__typename
						}
						__typename
					}
					pageInfo {
						hasNextPage
						endCursor
						__typename
					}
					__typename
				}
			}`,me=`query FetchWatchlist($identityId: ID!, $first: Int, $after: String, $sort: WatchedSecuritySort) {
                identity(id: $identityId) {
                  watchedSecurities(first: $first, after: $after, sort: $sort) {
                    totalCount
                    edges {
                      node {
                        id
                        active
                        activeDate
                        allowedOrderSubtypes
                        buyable
                        sellable
                        currency
                        depositEligible
                        inactiveDate
                        historicalQuotes(timeRange: "1d") {
                          adjustedPrice
                          currency
                          date
                          securityId
                          time
                          __typename
                        }
                        quote {
                          amount
                          currency
                          last
                          open
                          previousClose
                          securityId
                          __typename
                        }
                        securityType
                        status
                        stock {
                          description
                          name
                          primaryMic
                          symbol
                          ipoState
                          primaryExchange
                          usPtp
                          __typename
                        }
                        wsTradeEligible
                        wsTradeIneligibilityReason
                        optionsEligible
                        __typename
                      }
                      __typename
                    }
                    __typename
                  }
                  __typename
                }
              }`;var ue=class{cache=new Map;async setItem(e,t){this.cache.set(e,t)}async removeItem(e){this.cache.delete(e)}async getItem(e){return this.cache.get(e)??null}};var he=u(k,[u(ue)],"inMemoryService");function U(e){return _(w(f({},e),{cacheService:he}))}var et=Object.defineProperty,tt=Object.getOwnPropertyDescriptor,Xt=(e=>typeof M<"u"?M:typeof Proxy<"u"?new Proxy(e,{get:(t,a)=>(typeof M<"u"?M:t)[a]}):e)(function(e){if(typeof M<"u")return M.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')}),P=(e,t,a,r)=>{for(var i=r>1?void 0:r?tt(t,a):t,s=e.length-1,o;s>=0;s--)(o=e[s])&&(i=(r?o(t,a,i):o(i))||i);return r&&i&&et(t,a,i),i},I=(e,t)=>(a,r)=>t(a,r,e);var Z=class{baseUrl="https://trade-service.wealthsimple.com";tokenUrl="https://api.production.wealthsimple.com/v1/oauth/v2/token";yahooApiV7="https://query2.finance.yahoo.com/v7";yahooApiV11="https://query2.finance.yahoo.com/v11";graphqlUrl="https://my.wealthsimple.com/graphql";tokenKey="WealthSimpleTokenKey";refreshTokenKey=`${this.tokenKey}Refresh`;crumbKey="YahooCrumbKey";shortExpiry=55*60*1e3;clientId="4da53ac2b03225bed1550eba8e4611e086c7b905a3855e6ed12ea08c246758fa";async sendRequest(e,t,a=null,r={}){let i=f({"Content-Type":r.responseType==="text"?"text/plain":"application/json","my-org-extension":"true"},r.headers),s=await fetch(t,{method:e,headers:i,body:a?JSON.stringify(a):null});if(s.status===401)throw t.includes(this.yahooApiV7)?g.removeItem(this.crumbKey):g.removeItem(this.tokenKey),new Error("Unauthorized");if(!s.ok)throw new Error(`HTTP error ${s.status}`);return r.responseType==="text"?s.text():s.json()}async getCachedToken(){return await g.getItem(this.tokenKey)||await this.authenticate()}async authenticate(e){let t=await g.getItem(this.refreshTokenKey),a=!!t&&!e,r;if(a)r={grant_type:"refresh_token",refresh_token:t,client_id:this.clientId};else{if(!e||!e.email||!e.password)throw new Error("Credentials are required for password authentication");r={grant_type:"password",username:e.email,password:e.password,skip_provision:!0,otp_claim:null,scope:"invest.read invest.write trade.read trade.write tax.read tax.write",client_id:this.clientId}}let i={"Content-Type":"application/json"};!a&&e&&e.otp&&(i["x-wealthsimple-otp"]=`${e.otp};remember=true`);let s=await this.sendRequest("POST",this.tokenUrl,r,{headers:i});if(s.error)throw new Error(s.error);return await g.setItem(this.tokenKey,s.access_token,"",this.shortExpiry),await g.setItem(this.refreshTokenKey,s.refresh_token,"",T),s.access_token}clearTokens(){g.removeItem(this.tokenKey),g.removeItem(this.refreshTokenKey)}async fetchGraphql(e,t){let a=await this.getCachedToken();return this.sendRequest("POST",this.graphqlUrl,{query:e,variables:t},{headers:{Authorization:`Bearer ${a}`}})}async fetchYahoo(e,t,a=!1){let r=`${e}?${new URLSearchParams(t).toString()}`;return this.sendRequest("GET",r,null,{responseType:a?"text":"json"})}async loginUser(e){return this.authenticate(e)}async checkLogin(){let e=await g.getItem(this.tokenKey),t=await g.getItem(this.refreshTokenKey);return!!(e||t)}async logout(){this.clearTokens()}async initialize(){let e=await this.checkLogin();if(!e)return{loggedIn:e,accounts:[],selectedAccount:null};let t=(await this.getAccountList()).results.sort((i,s)=>s.net_deposits.amount-i.net_deposits.amount),a=localStorage.getItem("selectedAccount"),r=a?t.find(i=>i.id===JSON.parse(a).id):t.find(i=>i.account_type==="ca_non_registered");return{loggedIn:e,accounts:t,selectedAccount:r||t[0]}}storeSelectedAccount(e){localStorage.setItem("selectedAccount",JSON.stringify(e))}async getAccountList(){let e=await this.getCachedToken();return this.sendRequest("GET",`${this.baseUrl}/account/list`,null,{headers:{Authorization:`Bearer ${e}`}})}async getPositions(){let e=await this.getCachedToken();return this.sendRequest("GET",`${this.baseUrl}/account/positions`,null,{headers:{Authorization:`Bearer ${e}`}})}async deleteOrder(e){let t=await this.getCachedToken();return this.sendRequest("DELETE",`${this.baseUrl}/orders/${e}`,null,{headers:{Authorization:`Bearer ${t}`}})}async createQuote(e,t,a,r){if(!e.position.id||e.quantity<1||e.price<=0)throw new Error("Invalid inputs");let i=await this.getCachedToken(),s=f({account_id:a,order_type:r,order_sub_type:"limit",security_id:e.position.id,quantity:Number(e.quantity),limit_price:Number(e.price)},t&&{time_in_force:"until_cancel"});return this.sendRequest("POST",`${this.baseUrl}/orders`,s,{headers:{Authorization:`Bearer ${i}`}})}async getYahooQuotes(e){let t=await this.getCrumb();return this.fetchYahoo(`${this.yahooApiV7}/finance/quote`,{symbols:e.join(","),crumb:t})}async getYahooQuoteDetails(e){return this.fetchYahoo(`${this.yahooApiV11}/finance/quoteSummary/${e}`,{modules:"summaryProfile,financialData,defaultKeyStatistics"})}async getWatchlist(){let e=(await this.fetchGraphql(me,{identityId:"identity-ev8V2eR3e4CuR33YGKfZQDuByxZ"})).data.identity.watchedSecurities.edges.map(t=>t.node);return{crypto_securities:[],securities:e}}async getScheduledActivities(e){let t=new Date().toISOString(),a={orderBy:["OCCURRED_AT_ASC"],first:50,condition:{accountIds:e,types:["DIY_BUY"],unifiedStatuses:["PENDING"],startDate:t}};return(await this.fetchGraphql(de,a)).data.activityFeedItems.edges.map(r=>r.node)}async getActivities(e,t,a){return[]}async fetchPortfolio(e){let[t,a,r]=await Promise.all([this.getPositions(),this.getActivities(50,[e]),this.getWatchlist()]),i=t.results.filter(p=>p.account_id===e),s=[...r.securities],o=[...i,...s.filter(p=>!i.some(y=>y.stock.symbol===p.stock.symbol))],n=Y(a.filter(p=>p.object==="order"&&["posted","submitted"].includes(p.status)),["symbol","status","order_type"]),l=o.map(p=>this.buildPosition(p,n[p.stock.symbol]||{}));(await this.getYahooQuotes(l.map(p=>p.yahooStockSymbol))).quoteResponse.result.forEach(p=>(p.regularMarketChangePercent=h(p.regularMarketChangePercent),p.dayReturnOnAvgPercent=h(p.dayReturnOnAvgPercent),p.yesterdaysReturnPercent=h(p.yesterdaysReturnPercent),p.fiftyDayAverageChangePercent=h(p.fiftyDayAverageChangePercent),p.twoHundredDayAverageChangePercent=h(p.twoHundredDayAverageChangePercent),p.regularMarketChange=h(p.regularMarketChange),Object.assign(Q(l,["yahooStockSymbol"]).get(p.symbol)[0],p)));let c=this.calculateSummary(l);return l.forEach(p=>p.holdingPerct=h(Number(p.totalPurchasedCurrent)/c.total*100)),{positions:l,summary:c}}buildPosition(e,t){let a={id:e.id,stockSymbol:e.stock.symbol,quantity:e.quantity,currentPriceWS:h(e.quote?.last*1),averagePrice:h(e.book_value?.amount/e.quantity),totalPurchased:h(e.book_value?.amount),totalPurchasedCurrentWS:h(e.quote?.last*e.quantity),totalDifferenceWS:h(e.quote?.last*e.quantity-e.book_value?.amount),differenceWS:h(e.quote?.last-e.book_value?.amount/e.quantity),stockName:e.stock.name,stockPrimaryExchange:e.stock.primary_exchange||e.stock.primaryExchange,currency:e.quote?.currency,previousClose:e.quote?.previous_close||e.quote?.previousClose};return a.yahooStockSymbol=`${a.stockSymbol.replace(".","-")}${a.stockPrimaryExchange?.includes("TSX-V")?".V":a.stockPrimaryExchange?.includes("TSX")?".TO":""}`,a.yahooStockSymbol==="BTC"&&(a.yahooStockSymbol="BTC-USD"),t&&this.addOrderDetails(a,t),a}calculateSummary(e){let t={gain:0,loss:0,gainWS:0,lossWS:0,totalPurchased:0,total:0,totalWS:0,todaysReturnAllShares:0,todaysReturnAllSharesWS:0};return e.forEach(a=>{a.hasOrders&&this.calculateOrderDependentFields(a),this.calculateCommonFields(a),a.totalPurchased>0&&(t.totalPurchased+=a.totalPurchased,t.total+=a.totalPurchasedCurrent,t.totalWS+=a.totalPurchasedCurrentWS,t.gain+=a.totalDifference>0?a.totalDifference:0,t.loss+=a.totalDifference<0?a.totalDifference:0,t.gainWS+=a.totalDifferenceWS>0?a.totalDifferenceWS:0,t.lossWS+=a.totalDifferenceWS<0?a.totalDifferenceWS:0,t.todaysReturnAllShares+=a.todaysReturnAllShares,t.todaysReturnAllSharesWS+=(a.currentPriceWS-a.previousClose)*a.quantity)}),t}addOrderDetails(e,t){e.pending=t.submitted?.buy_quantity||[];let a=e.pending.map(l=>l.limit_price);e.lastPendingPurchasePrice=h(a.at(0)),e.minPendingPurchasePrice=h(a.sort((l,c)=>l-c).at(0));let r=t.posted?.buy_quantity?.map(l=>l.market_value/l.quantity)||[];e.lastPurchasePrice=h(r.at(0));let i=r.sort((l,c)=>l-c);e.min=h(i.at(0)),e.max=h(i.at(-1)),e.pendingSell=t.submitted?.sell_quantity||[];let s=e.pendingSell.map(l=>l.limit_price);e.lastPendingPurchasePriceSell=h(s.at(0)),e.minPendingPurchasePriceSell=h(s.sort((l,c)=>l-c).at(0)),e.maxPendingPurchasePriceSell=h(s.sort((l,c)=>l-c).at(-1));let o=t.posted?.sell_quantity?.map(l=>l.market_value/l.quantity)||[];e.lastPurchasePriceSell=h(o.at(0));let n=o.sort((l,c)=>l-c);e.minSell=h(n.at(0)),e.maxSell=h(n.at(-1)),e.hasOrders=!0}calculateCommonFields(e){e.totalPurchasedCurrent=h(e.regularMarketPrice*e.quantity),e.totalDifference=h(e.totalPurchasedCurrent-e.totalPurchased),e.difference=h(e.regularMarketPrice-e.averagePrice),e.dayLowDiff=h(e.regularMarketPrice-e.regularMarketDayLow),e.dayLowDiffPerct=h(e.dayLowDiff/e.regularMarketDayLow*100),e.dayHighDiff=h(e.regularMarketPrice-e.regularMarketDayHigh),e.dayHighDiffPerct=h(e.dayHighDiff/e.regularMarketDayHigh*100),e.dayRangePos=h((e.regularMarketPrice-e.regularMarketDayLow)/(e.regularMarketDayHigh-e.regularMarketDayLow)*100),e.fiftyTwoWeekRangePos=h((e.regularMarketPrice-e.fiftyTwoWeekLow)/(e.fiftyTwoWeekHigh-e.fiftyTwoWeekLow)*100),e.todaysReturnAllShares=h(e.regularMarketChange*e.quantity),e.dayReturnOnAvgPercent=h(e.regularMarketChange/e.averagePrice*100),e.yesterdaysReturnPercent=h((e.regularMarketPreviousClose/e.averagePrice-1)*100),e.returnPercent=h((e.totalPurchasedCurrent/e.totalPurchased-1)*100);let t=e.totalPurchased*(e.returnPercent/-15-1)/e.regularMarketPrice;e.return15=t>0?Math.ceil(t):Math.floor(t),e.fiftyDayAverageChangePercent*=100,e.twoHundredDayAverageChangePercent*=100,e.fiftyTwoWeekHighChangePercent*=100,e.fiftyTwoWeekLowChangePercent*=100}calculateOrderDependentFields(e){e.currMinDiff=h(e.regularMarketPrice-e.min),e.currMinDiffPerct=h(e.currMinDiff/e.min*100),e.minMaxRange=`${e.min} - ${e.max}`,e.currMaxDiff=h(e.regularMarketPrice-e.max),e.currMaxDiffPerct=h(e.currMaxDiff/e.max*100),e.maxAvgPerct=h((e.max-e.averagePrice)/e.max*100),e.avgMinPerct=h((e.averagePrice-e.min)/e.min*100),e.minMaxPerct=h((e.min/e.max-1)*100)}sortPositions(e,t,a=!1){if(!t?.prop||t.disabled)return e;let r=t.prop,i=a?-1:1;return e.sort((s,o)=>{let[n,l]=[s[r],o[r]];return n===void 0?1:l===void 0?-1:!!s.totalPurchased!=!!o.totalPurchased?s.totalPurchased?-1:1:(n>l?1:n<l?-1:0)*i})}setChecked(e,t){e.forEach(a=>a.selected=t)}toggleSelectAll(e){this.setChecked(e,e.some(t=>!t.selected))}async getCrumb(e=!1){let t=await g.getItem(this.crumbKey);if(t&&!e)return t;let a=await this.fetchYahoo("https://query2.finance.yahoo.com/v1/test/getcrumb",{},!0);return await g.setItem(this.crumbKey,a,"",T),a}};P([U({keyName:"wealthsimple-positions",ttl:5*60*1e3})],Z.prototype,"getPositions",1),P([U({keyName:"wealthsimple-getWatchlist",ttl:5*60*1e3})],Z.prototype,"getWatchlist",1);var ye=(e=>(e.BuyQuantity="buy_quantity",e.SellQuantity="sell_quantity",e))(ye||{});function fe(){let e=globalThis.exec,t=globalThis.createServer,a=globalThis.parse;return{exec:e,createServer:t,parse:a}}function K(){let e=globalThis.fs,t=globalThis.os,a=globalThis.path;return{fs:e,os:t,path:a}}var ge=class we{data={};storagePath="";lockPath="";initialized=!1;async initialize(){if(this.initialized)return;let{fs:t,os:a,path:r}=K(),i=we.name,s=r.join(a.homedir(),`.${i}`);this.storagePath=r.join(s,"storage.json"),this.lockPath=this.storagePath+".lock",t.existsSync(s)||t.mkdirSync(s,{recursive:!0}),t.existsSync(this.storagePath)||t.writeFileSync(this.storagePath,JSON.stringify({}),"utf8");try{let o=t.readFileSync(this.storagePath,"utf8");this.data=JSON.parse(o)}catch{this.data={}}this.initialized=!0}async persist(){let{fs:t}=K();this.acquireLock(t);try{t.writeFileSync(this.storagePath,JSON.stringify(this.data,null,2),"utf8")}finally{this.releaseLock(t)}}acquireLock(t){let a=0;for(;t.existsSync(this.lockPath);){if(a++>20)throw new Error("Could not acquire lock");Atomics.wait(new Int32Array(new SharedArrayBuffer(4)),0,0,50)}t.writeFileSync(this.lockPath,"locked")}releaseLock(t){t.existsSync(this.lockPath)&&t.unlinkSync(this.lockPath)}async getItem(t){await this.initialize();let{fs:a}=K();try{let r=a.readFileSync(this.storagePath,"utf8");this.data=JSON.parse(r)}catch{this.data={}}return this.data[t]??null}async setItem(t,a){await this.initialize(),this.data[t]=a,await this.persist()}async removeItem(t){await this.initialize(),delete this.data[t],await this.persist()}};var W=u(k,[u(ge)],"localFileSystemService");function R(){return typeof window<"u"&&typeof window.document<"u"}function B(){return typeof process<"u"&&process.versions!=null&&process.versions.node!=null}async function D(e){if(R())return window.location.href=e,{redirected:!0,environment:"browser"};throw new Error("Cannot redirect in Node.js environment. Please provide a response object or onRedirect callback.")}function ve(e){if(R())return{queryParams:new URLSearchParams(window.location.search),hashParams:new URLSearchParams(window.location.hash.substring(1))};if(e){let t=new URLSearchParams(e.url?.split("?")[1]||""),a=new URLSearchParams;return{queryParams:t,hashParams:a}}else return{queryParams:new URLSearchParams,hashParams:new URLSearchParams}}var L=class{buildAuthUrl(e,t,a){let r=new URLSearchParams({client_id:e.clientId,redirect_uri:e.calculateRedirectUri(),response_type:a,scope:e.scopes.join(" "),state:`${t}:${e.route}`});if(e.duration&&r.append("duration",e.duration),e.extraParams)for(let[i,s]of Object.entries(e.extraParams))r.append(i,s);return`${e.authUrl}?${r.toString()}`}async requestToken(e,t,a,r,i,s){if(t.grant_type==="client_credentials"&&!r.clientSecret)throw new Error("Client secret is required for client credentials flow");let o=new URLSearchParams(t),n={"Content-Type":"application/x-www-form-urlencoded"};s||(n.Authorization=`Basic ${btoa(`${r.clientId}:${r.clientSecret||""}`)}`);let l=await fetch(e,{method:"POST",headers:n,body:o.toString()});if(!l.ok)throw new Error(`Token request failed: ${l.status}`);let c=await l.json();return i&&(c.refresh_token=c.refresh_token||i),await this.saveTokenToCache(a,c),c}async saveTokenToCache(e,t){let a=B()?W:g,r=f({},t);r.timeExpires=Date.now()+t.expires_in*1e3-6e4,await a.setItem(e,r,void 0,T)}};var Se=class extends L{async authenticate(e,t){let a=this.buildAuthUrl(t,e,"code");return await D(a),null}async handleCallback(e,t,a){if(!e.code||!a.tokenUrl)throw new Error("Missing code or token URL");await this.requestToken(a.tokenUrl,{grant_type:"authorization_code",code:e.code,redirect_uri:a.calculateRedirectUri()},t,a)}async refreshToken(e,t,a){if(!a.tokenUrl)throw new Error("Missing token URL");return this.requestToken(a.tokenUrl,{grant_type:"refresh_token",refresh_token:e},t,a,e)}};var ke=class extends L{codeVerifierKey="oauth_pkce_code_verifier";generateCodeVerifier(){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",t=Math.floor(Math.random()*86)+43,a="";for(let r=0;r<t;r++)a+=e.charAt(Math.floor(Math.random()*e.length));return a}async generateCodeChallenge(e){if(R()){let t=new TextEncoder().encode(e),a=await crypto.subtle.digest("SHA-256",t);return btoa(String.fromCharCode(...new Uint8Array(a))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}else try{return(await import("crypto")).createHash("sha256").update(e).digest().toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}catch{throw new Error("PKCE requires Node.js crypto module in server environment")}}async authenticate(e,t){let a=await this.buildAuthUrlAsync(t,e);return await D(a),null}async buildAuthUrlAsync(e,t){let a=this.generateCodeVerifier();await g.setItem(`${t}_${this.codeVerifierKey}`,a,void 0,5*60*1e3);let r=await this.generateCodeChallenge(a),i=new URLSearchParams({client_id:e.clientId,redirect_uri:e.calculateRedirectUri(),response_type:"code",scope:e.scopes.join(" "),state:`${t}:${e.route}`,code_challenge:r,code_challenge_method:"S256"});if(e.duration&&i.append("duration",e.duration),e.extraParams)for(let[s,o]of Object.entries(e.extraParams))i.append(s,o);return`${e.authUrl}?${i.toString()}`}async handleCallback(e,t,a){if(!e.code||!a.tokenUrl)throw new Error("Missing code or token URL");let r=await g.getItem(`${t}_${this.codeVerifierKey}`);if(!r)throw new Error("Code verifier not found");await g.removeItem(`${t}_${this.codeVerifierKey}`),await this.requestToken(a.tokenUrl,{grant_type:"authorization_code",code:e.code,redirect_uri:a.calculateRedirectUri(),code_verifier:r,client_id:a.clientId},t,a,void 0,!0)}async refreshToken(e,t,a){if(!a.tokenUrl)throw new Error("Missing token URL");return this.requestToken(a.tokenUrl,{grant_type:"refresh_token",refresh_token:e,client_id:a.clientId},t,a,e,!0)}};var be=class extends L{async authenticate(e,t){if(!t.tokenUrl)throw new Error("Missing token URL for client credentials flow");return this.requestToken(t.tokenUrl,{grant_type:"client_credentials",scope:t.scopes.join(" ")},e,t)}};var xe=class extends L{async authenticate(e,t){let a=this.buildAuthUrl(t,e,"token");if(R()){let r=document.getElementById("silentAuthIframe");r||(r=document.createElement("iframe"),r.id="silentAuthIframe",r.style.cssText="position:absolute;width:0;height:0;border:0;",document.body.appendChild(r)),r.src=a,await new Promise(s=>setTimeout(s,3e3));let i=await g.getItem(e);if(i?.access_token&&Date.now()<i.timeExpires)return i}return await D(a),null}async handleCallback(e,t,a){e.access_token&&await this.saveTokenToCache(t,e)}};var v={clientId:"2cf47201933b48a498be147ab61a46ee",clientSecret:"",authUrl:"https://accounts.spotify.com/authorize",tokenUrl:"https://accounts.spotify.com/api/token",calculateRedirectUri:()=>location.href.includes("spotify")?location.href.replace("/spotify","/token-callback").split("?")[0].split("#")[0]:"",route:"spotify",scopes:["playlist-modify-public","playlist-modify-private","user-read-playback-position","user-read-email","user-library-read","user-top-read","ugc-image-upload","user-follow-modify","user-modify-playback-state","user-read-recently-played","user-read-currently-playing","user-read-playback-state","user-follow-read","playlist-read-collaborative","user-library-modify","playlist-read-private","user-read-private"]},Te={reddit_cache_key:{clientId:"cOE9ZZmP0f5OMw",clientSecret:"",authUrl:"https://www.reddit.com/api/v1/authorize.compact",tokenUrl:"https://www.reddit.com/api/v1/access_token",scopes:["identity","edit","flair","history","modconfig","modflair","modlog","modposts","modwiki","mysubreddits","privatemessages","read","report","save","submit","subscribe","vote","wikiedit","wikiread"],calculateRedirectUri:()=>location.href.includes("reddit")?location.href.replace("/reddit","/token-callback").split("?")[0].split("#")[0]:"",route:"reddit",flowType:"authorization_code",local:{clientId:"Jw67D19qBRz8-g",clientSecret:""}},spotify_implicit_cache_key:{clientId:v.clientId,authUrl:v.authUrl,scopes:v.scopes,calculateRedirectUri:v.calculateRedirectUri,route:v.route,flowType:"implicit"},spotify_client_credentials_cache_key:{clientId:v.clientId,clientSecret:v.clientSecret,authUrl:"",tokenUrl:v.tokenUrl,scopes:v.scopes,calculateRedirectUri:v.calculateRedirectUri,route:"",flowType:"client_credentials"},spotify_authorization_code_cache_key:{clientId:v.clientId,clientSecret:v.clientSecret,authUrl:v.authUrl,tokenUrl:v.tokenUrl,scopes:v.scopes,calculateRedirectUri:v.calculateRedirectUri,route:v.route,flowType:"authorization_code"},spotify_authorization_code_pkce_cache_key:{clientId:v.clientId,authUrl:v.authUrl,tokenUrl:v.tokenUrl,scopes:v.scopes,calculateRedirectUri:v.calculateRedirectUri,route:v.route,flowType:"authorization_code_with_pkce"}};var X=class{flowServices={implicit:u(xe),authorization_code:u(Se),authorization_code_with_pkce:u(ke),client_credentials:u(be)};localAuthServer=null;async authenticateForNode(e){let{exec:t,createServer:a,parse:r}=fe(),i=8100,s="/token-callback",o=`http://localhost:${i}${s}`,n=w(f({},this.getConfig(e)),{redirectUri:o}),l=await this.fetchCachedItem(e);if(l?.access_token&&Date.now()<l.timeExpires)return l;let c=this.flowServices[n.flowType];if(l?.refresh_token&&typeof c.refreshToken=="function"&&["authorization_code","authorization_code_with_pkce"].includes(n.flowType))return c.refreshToken(l.refresh_token,e,n);let p=await this.buildAuthUrlForNode(c,n,e),y=this.startLocalAuthServer({createServer:a,parseUrl:r,port:i,redirectPath:s,providerKey:e,config:n,flow:c}),d=process.platform==="win32"?`start "" "${p}"`:process.platform==="darwin"?`open "${p}"`:`xdg-open "${p}"`;return t(d),y}async getToken(e){if(B())return this.authenticateForNode(e);let t=this.getConfig(e),a=await this.fetchCachedItem(e);if(a?.access_token&&Date.now()<a.timeExpires)return a;let r=this.flowServices[t.flowType];return a?.refresh_token&&typeof r.refreshToken=="function"&&["authorization_code","authorization_code_with_pkce"].includes(t.flowType)?r.refreshToken(a.refresh_token,e,t):r.authenticate(e,t)}async fetchCachedItem(e){return await(B()?W:g).getItem(e)}async handleRedirectCallback(){let{result:e,providerKey:t,redirectPath:a,config:r,flow:i}=await this.parseOAuthResponse();(e.access_token||e.code)&&i.handleCallback&&(await i.handleCallback(e,t,r),a&&await D(a))}async parseOAuthResponse(){let{queryParams:e,hashParams:t}=ve(),a=this.extractParametersFromUrl("",Object.fromEntries(e.entries()),!1);t.forEach((n,l)=>a[l]=n);let[r,i]=a.state?.split(":")??[];if(!r)throw new Error("Invalid state parameter");let s=this.getConfig(r),o=this.flowServices[s.flowType];return{result:a,providerKey:r,redirectPath:i,config:s,flow:o}}getConfig(e){let t=Te[e];if(!t)throw new Error(`Unknown OAuth provider: ${e}`);return R()&&window.location.hostname==="localhost"&&t.local?f(f({},t),t.local):t}extractParametersFromUrl(e,t,a=!0){let r={};if(Object.keys(t||{}).forEach(i=>r[i]=String(t[i])),a&&e.includes("#")){let i=e.split("#")[1];if(i){let s=new URLSearchParams(i);for(let[o,n]of s.entries())r[o]=n}}return r}async buildAuthUrlForNode(e,t,a){if(typeof e.buildAuthUrlAsync=="function"&&t.flowType==="authorization_code_with_pkce")return e.buildAuthUrlAsync(t,a);if(typeof e.buildAuthUrl=="function"&&["authorization_code","implicit"].includes(t.flowType))return e.buildAuthUrl(t,a,t.flowType==="implicit"?"token":"code");if(typeof e.authenticate=="function"&&t.flowType==="client_credentials"){let r=await e.authenticate(a,t);if(typeof r=="string")return r;throw new Error("Could not determine auth URL")}throw new Error("OAuth flow service does not support URL generation")}async startLocalAuthServer({createServer:e,parseUrl:t,port:a,redirectPath:r,providerKey:i,config:s,flow:o}){return new Promise((n,l)=>{if(this.localAuthServer){console.log("Local auth server is already running, reusing existing instance");return}this.localAuthServer=e(async(c,p)=>{if(c.url.startsWith(r))try{let y=t(c.url,!0),d=this.extractParametersFromUrl(c.url,y.query,c.method==="GET");d.state||(d.state=`${i}:${s.route}`),(d.access_token||d.code)&&o.handleCallback&&await o.handleCallback(d,i,s);let m=await this.fetchCachedItem(i);if(!m||!m.access_token)throw new Error("Token not found in cache");p.writeHead(200,{"Content-Type":"text/html"}),p.end("<html><body>Authentication successful. You can close this window</body></html>"),n(m)}catch(y){p.writeHead(500,{"Content-Type":"text/html"}),p.end("<html><body>Authentication failed.</body></html>"),l(y)}finally{setTimeout(()=>{this.localAuthServer&&(this.localAuthServer.close(),this.localAuthServer=null)},1e3)}}),this.localAuthServer.listen(a)})}};var at=class{element=null;constructor(e){this.createLoadingElement(e)}createLoadingElement(e){let t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;this.element=document.createElement("div"),this.element.style.position="fixed",this.element.style.top="0",this.element.style.left="0",this.element.style.width="100%",this.element.style.height="100%",this.element.style.backgroundColor=t?"rgba(0, 0, 0, 0.2)":"rgba(255, 255, 255, 0.8)",this.element.style.display="flex",this.element.style.alignItems="center",this.element.style.justifyContent="center",this.element.style.zIndex="9999";let a=document.createElement("div");a.style.padding="20px",a.style.display="flex",a.style.flexDirection="row",a.style.alignItems="center",a.style.gap="16px",a.style.minWidth="250px",a.style.backgroundColor=t?"#1e1e1e":"#f0f0f0",a.style.borderRadius="8px";let r=document.createElement("div");r.style.width="32px",r.style.height="32px",r.style.border="4px solid rgba(0, 0, 0, 0.1)",r.style.borderTopColor="#3498db",r.style.borderRadius="50%",r.style.animation="spin 1s linear infinite";let i=document.createElement("style");i.textContent=`
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    `,document.head.appendChild(i);let s=document.createElement("div");s.textContent=e,s.style.color=t?"#c0c0c0":"#404040",a.appendChild(r),a.appendChild(s),this.element.appendChild(a)}async present(){this.element&&document.body.appendChild(this.element)}async dismiss(){this.element&&this.element.parentNode&&(this.element.parentNode.removeChild(this.element),this.element=null)}};function rt(e){return function(t,a,r){let i=r.value;return r.value=async function(...s){let o=t[O.name]?.get(a)||[],n=s.filter((p,y)=>o?.includes(y)).join(", "),l=`${e.message} ${n}`,c=new at(l);window.loading=c,await c.present();try{return await i.call(this,...s)}finally{await c.dismiss()}},r}}var J=class{dbPromise=null;storeName="keyval";getDbPromise(){return this.dbPromise===null&&(typeof indexedDB>"u"?this.dbPromise=Promise.reject(new Error("IndexedDB not available")):this.dbPromise=new Promise((e,t)=>{let a=indexedDB.open("keyval-store",3);a.onerror=()=>t(a.error),a.onsuccess=()=>e(a.result),a.onupgradeneeded=()=>a.result.createObjectStore(this.storeName)})),this.dbPromise}async runTransaction(e,t){let a=await this.getDbPromise();return new Promise((r,i)=>{let s=a.transaction(this.storeName,e).objectStore(this.storeName),o=t(s);o.onsuccess=()=>r(o.result),o.onerror=()=>i(o.error)})}async getItem(e){return this.runTransaction("readonly",t=>t.get(e))}async getAllKeys(){return this.runTransaction("readonly",e=>e.getAllKeys())}async setItem(e,t){await this.runTransaction("readwrite",a=>a.put(t,e))}async removeItem(e){await this.runTransaction("readwrite",t=>t.delete(e))}};var Pe="CACHESERVICE.SESSION_CACHE_ID",Ie=class extends J{async getItem(e){let t=await super.getItem(e),a=await this.getOrLoadSessionCacheId(),r=typeof t=="string";return r&&(t=t?JSON.parse(t):void 0),t?.sessionCacheId!==a&&(await this.removeItem(e),t=void 0),r?JSON.stringify(t):t}async setItem(e,t){let a=await this.getOrLoadSessionCacheId(),r=typeof t=="string";r&&(t=JSON.parse(t)),a&&(t.sessionCacheId=a),await super.setItem(e,r?JSON.stringify(t):t)}async removeItem(e){await super.removeItem(e)}async getAllKeys(){return super.getAllKeys()}getOrLoadSessionCacheId(){let e=sessionStorage.getItem(Pe);return e||(e=Date.now().toString(),sessionStorage.setItem(Pe,e)),e}};var it=u(k,[u(Ie)],"indexedDbSessionService");function Ce(e){return _(w(f({},e),{cacheService:it}))}var Ae="https://api.spotify.com",st="http://localhost:8087",ot="spotify_authorization_code_pkce_cache_key",$=class{oauthService=u(X);async getToken(){return(await this.oauthService.getToken(ot)).access_token}async fetchPagedItems(e,t,a=!1){if(!e)return[];let r=[],i=e;for(;i;){let s=await this.sendApiRequest(i,"GET",void 0,void 0,a);s.items&&(r=r.concat(s.items)),i=s.next}return r}async sendApiRequest(e,t,a,r,i){let s={Authorization:`Bearer ${await this.getToken()}`,"Content-Type":"application/json"},o=r?`?${new URLSearchParams(r).toString()}`:"",n=await fetch(`${e}${o}`,{method:t,headers:s,body:a?JSON.stringify(a):void 0});if(!n.ok){let p;try{p=await n.json()}catch{}throw new Error(`Error: ${n.status}, ResponseObject: ${JSON.stringify(p)}`)}if(n.status===204)return{};let l=n.headers.get("Content-Length")||n.headers.get("content-length");if(l&&parseInt(l)===0)return{};let c=n.headers.get("Content-Type")||n.headers.get("content-type")||"text/plain";return c&&c.includes("application/json")?n.json():c&&c.includes("text/")?n.text():{}}async fetchExternalData(e){let t=await fetch(`${st}${e}`,{method:"GET",headers:{"my-org-extension":"true"}});if(!t.ok)throw new Error(`Error: ${t.status}`);return t.json()}async makeApiCall(e,t="GET",a,r,i){let s=e.startsWith("http")?e:`${Ae}${e}`;return this.sendApiRequest(s,t,a,r,i)}getBaseUrl(){return Ae}};P([Ce({ttl:1e3*60*60*24*1}),I(0,A),I(4,E)],$.prototype,"sendApiRequest",1);var q=u(k,[u(J)],"indexedDbService");var ee="MoodGenreSampledData",C=class{spotifyApiService=u($);filterCondition(e,t){if(!e||!t||!e.owner)return!1;if(e.trackId===t.trackId)return!0;let a=e.trackName?.toLowerCase()||"",r=t.trackName?.toLowerCase()||"";if(!(a===r||a.substring(0,5)===r.substring(0,5)&&(a.includes(r)||r.includes(a))))return!1;let i=e.albumId?.toLowerCase(),s=t.albumId?.toLowerCase(),o=e.albumName?.toLowerCase(),n=t.albumName?.toLowerCase(),l=e.artistId?.toLowerCase(),c=t.artistId?.toLowerCase(),p=e.artistName?.toLowerCase(),y=t.artistName?.toLowerCase();return i===s||o===n||l===c||p===y}groupTracksBy(e,t){let a=new Map;for(let r of e){let i=t(r),s=a.get(i);s?s.push(r):a.set(i,[r])}return a}parsePlaylistName(e){let t=e.match(/^(.*?)(?:#(\d+))?$/),a=t?.[1].trim()||"";return{currentRank:Number(t?.[2]||1),baseName:a}}_updateRecentlyPlayedTracks(e,t){t?.forEach((a,r)=>{let i=e.find(s=>s.owner&&s.trackId===a.trackId&&s.playlistId===a.playlistId||this.filterCondition(s,a));i?.type!=="Current"&&(i?(i.recentlyPlayedIndex===9999999&&(i.recentlyPlayedIndex=r+1),i.type="Recent"):(a.recentlyPlayedIndex=r+1,a.type="Recent",e.push(a)))})}_markDuplicates(e){for(let t of e)if(!t.duplicateCountMarked){let a=e.filter(r=>this.filterCondition(t,r));if(a.length>1)for(let r of a)r.duplicateCount=a.length,r.duplicateCountMarked=!0}}async fetchTrackList(e,t){let a=await this.fetchUserPlaylists(e||t.length>0);return(await Promise.all(a.map(r=>{let i=t.find(o=>o.playlistId===r.id),s=i?i.snapshot_id:r.snapshot_id;return this.fetchPlaylistTracks(w(f({},r),{snapshot_id:s}),!!i||e)}))).flat()}async saveUserTracks(e){if(e.length>50)throw new Error("A maximum of 50 items can be saved in one request.");if(!e.length)throw new Error("No tracks to save.");return this.spotifyApiService.makeApiCall("/v1/me/tracks","PUT",{ids:e},void 0,!0)}async batchDeletePlaylistTracks(e){let t=e.filter(i=>i.owner);if(!t.length)return[];let a=this.groupTracksBy(t,i=>i.playlistId),r=[];for(let[i,s]of a.entries())try{let o=await this.deleteTracksFromPlaylist(i,s);r.push({playlistId:i,snapshot_id:o.snapshot_id})}catch{r.push({playlistId:i,snapshot_id:"ERROR"})}return r}async moveTracks(e,t,a){if(!e.length)throw new Error("No tracks to move.");let r=await this.addTracksToPlaylist(e.map(s=>s.uri),t,a),i=await this.batchDeletePlaylistTracks(e);return[r,...i]}async getMoodGenreSampledData(){let e=await q.getItem(ee);if(e)return e;let t=await this.spotifyApiService.fetchExternalData("/spotify/genres-mood-sampled");return await q.setItem(ee,t),t}updateCurrentTrack(e,t){if(!t)return;let a=e.find(i=>i.type==="Current"),r=e.find(i=>i.owner&&i.trackId===t.trackId&&i.playlistId===t.playlistId||this.filterCondition(i,t));r?(r.recentlyPlayedIndex=0,r.type="Current",r.isShuffleActive=t.isShuffleActive):(t.recentlyPlayedIndex=0,t.type="Current",e.push(t)),a&&a.trackId!==r?.trackId&&(a.recentlyPlayedIndex=9999999,a.type="Recent")}async searchTracks(e,t=20,a=0){return this.spotifyApiService.makeApiCall(`/v1/search?q=${encodeURIComponent(e)}&type=track&limit=${t}&offset=${a}`)}async fetchUserPlaylists(e){let t=this.spotifyApiService.getBaseUrl();return this.spotifyApiService.fetchPagedItems(`${t}/v1/me/playlists`,void 0,e)}async fetchPlaylistById(e,t){return this.spotifyApiService.makeApiCall(`/v1/playlists/${e}`,"GET",void 0,void 0,t)}async createUserPlaylist(e){return this.spotifyApiService.makeApiCall("/v1/users/mahindar5/playlists","POST",{name:e,public:!0},void 0,!0)}async deletePlaylistTracksAll(e){return this.spotifyApiService.makeApiCall(`/v1/playlists/${e}/tracks`,"DELETE",void 0,void 0,!0)}async deleteTracksFromPlaylist(e,t){return t.length?this.spotifyApiService.makeApiCall(`/v1/playlists/${e}/tracks`,"DELETE",{tracks:t.map(a=>({uri:a.uri}))},void 0,!0):{snapshot_id:null}}async addTracksToPlaylist(e,t,a=null){let r={uris:e};return a!=null&&(r.position=a.toString()),this.spotifyApiService.makeApiCall(`/v1/playlists/${t}/tracks`,"POST",r,void 0,!0).then(i=>({playlistId:t,snapshot_id:i.snapshot_id}))}async reorderPlaylistTracks(e,t,a=1){if(e.type=="Current"&&!e.isShuffleActive)throw new Error("Cannot reorder tracks when shuffle is not active. As it messes up the playing queue.");let r=e.indexInPlaylist<t?t+a-1:t-1;return this.spotifyApiService.makeApiCall(`/v1/playlists/${e.playlistId}/tracks`,"PUT",{snapshot_id:e.playlistSnapshotId,insert_before:r,range_start:e.indexInPlaylist,range_length:a},void 0,!0)}async fetchPlaylistTracks(e,t){let a=await this.spotifyApiService.fetchPagedItems(e.tracks?.href,"snapshot_id_"+e.snapshot_id,t),r=await q.getItem(ee)||{};return a.map((i,s)=>this.mapRawTrackToModel(i,e,s,r)).filter(i=>!!i)}mapRawPlaylistResponse(e){return{playlistId:e.id,playlistName:e.name,playlistLength:e.tracks?.total||0,playlistSnapshotId:e.snapshot_id,duplicateCount:1,recentlyPlayedIndex:9999999,owner:e.owner?.id==="mahindar5"}}mapRawTrackResponse(e,t,a){let r=e.track;return{trackId:r.id,trackName:r.name,artistId:r.artists?.[0]?.id||"",artistName:r.artists?.map(i=>i.name).join(", ")||"",albumId:r.album?.id||"",albumName:r.album?.name||"",albumImage:r.album?.images?.[0]?.url||"",uri:r.uri,playlistId:t.id,playlistName:t.name,playlistLength:t.tracks?.total||0,playlistSnapshotId:t.snapshot_id,indexInPlaylist:a,currentPlaylistRank:1,duplicateCount:1,duplicateCountMarked:!1,recentlyPlayedIndex:9999999,checked:!1,owner:t.owner?.id==="mahindar5",addedAt:new Date(e.added_at)}}async createPlaylist(e){let t=await this.createUserPlaylist(e.name);if(e.tracks.length>0){let a=e.tracks.map(r=>r.uri);await this.addTracksToPlaylist(a,t.id)}return t.id}mapRawTrackToModel(e,t,a,r={}){if(!e?.track)return null;let i=e.track,s=i.album?.images||[];t=t||{};let o=t.name||t.uri?.split(":").pop()||"",{currentRank:n,baseName:l}=this.parsePlaylistName(o);return{trackId:i.id,uri:i.uri,trackName:i.name,artistId:i.artists?.map(c=>c.id).join(",")||"",artistName:i.artists?.map(c=>c.name).join(",")||"",playlistId:t.id||t.uri?.split(":").pop(),playlistName:o,currentPlaylistRank:n,albumId:i.album?.id,albumName:i.album?.name,albumImage:s[2]?.url||s[1]?.url||s[0]?.url,indexInPlaylist:a,playlistLength:t.tracks?.total||0,playlistSnapshotId:t.snapshot_id,duplicateCount:1,recentlyPlayedIndex:9999999,owner:t.owner?.id==="mahindar5",addedAt:e.added_at?new Date(e.added_at):void 0,isShuffleActive:e.shuffle_state,type:e.type,mood:r[i.id]?.mood?.value||"",moodRank:r[i.id]?.mood?.rank||"",genre:r[i.id]?.genre?.value||"",genreRank:r[i.id]?.genre?.rank||""}}async fetchPlaylistWithAllTracks(e,t){let a=await this.fetchPlaylistById(e,t),r=a?.tracks?.items||[];if(a?.tracks?.next){let i=await this.spotifyApiService.fetchPagedItems(a.tracks.next,void 0,t);r.push(...i)}return r.filter(i=>i.track).map((i,s)=>this.mapRawTrackToModel(i,a,s)).filter(i=>!!i)}};P([I(0,O)],C.prototype,"createUserPlaylist",1);var te=class{spotifyApiService=u($);spotifyTrackPlaylistService=u(C);async sendExtensionCommand(e){return z("ChromeTabHelper","commandSpotify",{command:e})}async fetchCurrentUserPlayback(){let e=await this.spotifyApiService.makeApiCall("/v1/me/player","GET",void 0,void 0,!0);if(e?.item)return this.spotifyTrackPlaylistService.mapRawTrackToModel({track:e.item,added_at:e.timestamp,shuffle_state:e.shuffle_state,type:"Current"},e.context,e.item.track_number)||void 0}async fetchRecentTracks(){return(await this.spotifyApiService.makeApiCall("/v1/me/player/recently-played","GET",void 0,{offset:"0",limit:"50"},!0)).items?.map((e,t)=>this.spotifyTrackPlaylistService.mapRawTrackToModel(e,e.context,t)).filter(e=>!!e)||[]}async getRecentlyPlayedTracks(e=50){return(await this.spotifyApiService.makeApiCall("/v1/me/player/recently-played","GET",void 0,{offset:"0",limit:e.toString()},!0)).items?.map((t,a)=>this.spotifyTrackPlaylistService.mapRawTrackToModel(t,t.context,a)).filter(t=>!!t)||[]}async playPlaylistTrack(e){let t=await this.spotifyApiService.makeApiCall("/v1/me/player/play","PUT",{context_uri:`spotify:playlist:${e.playlistId}`,offset:{uri:e.uri}});return t.success??t}};var Ee=class{async setItem(e,t){sessionStorage.setItem(e,t)}async removeItem(e){sessionStorage.removeItem(e)}async getItem(e){return sessionStorage.getItem(e)}};var nt=u(k,[u(Ee)],"sessionStorageService");function _e(e){return _(w(f({},e),{cacheService:nt}))}async function De(e,t,a){if(!Array.isArray(e)||e.length===0||a<1)return;let r=Math.ceil(e.length/a);for(let i=0;i<a;i++){let s=e.slice(i*r,(i+1)*r);if(!s.length)continue;let o=t.replace(/(\.csv)?$/,`_${s.length}_${i+1}.csv`);await pt(s,o)}}function lt(e){if(!e.length)return"";let t=[...new Set(e.flatMap(Object.keys))],a=i=>i==null?"":/["\n,]/.test(i)?`"${String(i).replace(/"/g,'""')}"`:String(i),r=e.map(i=>t.map(s=>a(i[s])).join(","));return[t.join(","),...r].join(`
`)}function Re(e){e=e.trim();let t=[],a="",r=!1;for(let i=0;i<e.length;i++){let s=e[i],o=e[i+1];s==='"'?r&&o==='"'?(a+='"',i++):r=!r:s===","&&!r?(t.push(a),a=""):a+=s}return t.push(a),t}function ct(e,t=!1){let a=e.split(/\r?\n/).filter(Boolean);if(!a.length)return[];let r=Re(a[0]).map(i=>(i.replace(/^"|"$/g,""),t?i.toLowerCase():i));return a.slice(1).map(i=>{let s=Re(i).map(n=>n.replace(/^"|"$/g,"").replace(/""/g,'"')),o={};return r.forEach((n,l)=>{o[n]=s[l]??""}),o})}async function pt(e,t){let a=new Blob([lt(e)],{type:"text/csv"}),r=await(await showSaveFilePicker({suggestedName:t,types:[{description:"CSV files",accept:{"text/csv":[".csv"]}}]})).createWritable();await r.write(a),await r.close()}async function dt(e,t=!1){let a=await e.text();return ct(a,t)}async function Le(e,t=[]){for await(let[,a]of e.entries())if(a.kind==="file"&&a.name.endsWith(".csv"))t.push(await a.getFile());else if(a.kind==="directory"){let r=await a;await Le(r,t)}return t}async function Me(e=!1){let t=await showDirectoryPicker(),a=await Le(t);return Promise.all(a.map(r=>dt(r,e)))}var mt="MoodGenreSampledData",N=class{spotifyApiService=u($);async getPlayCountByArtist(e,t){return this.spotifyApiService.fetchExternalData(`/artistInfo?artistid=${e}`)}async getPlayCountByAlbum(e,t){return this.spotifyApiService.fetchExternalData(`/albumPlayCount?albumid=${e}`)}async fetchViewCount(e,t=!1,a=!1){let r=await Promise.all(e.map(async i=>{try{let s=(await this.getPlayCountByAlbum(i.albumId,a))?.data?.discs?.flatMap(o=>o.tracks)?.find(o=>o.uri===i.uri)?.playcount;return{[i.trackId]:Number(s)||0}}catch{return{[i.trackId]:0}}}));return Object.assign({},...r)}async exportAllTracksToCsvFile(e){let t=e.map(a=>({id:a.trackId,title:a.trackName,artist:a.artistName,album:a.albumName,snapshotId:a.playlistSnapshotId,playlistId:a.playlistId,playlistName:a.playlistName,rank:a.currentPlaylistRank,uri:a.uri,index:a.indexInPlaylist,length:a.playlistLength}));De(t,"all_tracks.csv",5)}async filterPropertiesByCategory(e=""){let[t,a]=e.split(":"),r=await this.uploadCsvFolderToLogJson(!0);return[...new Set(r.filter(i=>i.categories[t].value.toLowerCase().includes(a.toLowerCase())).map(i=>i.id))].join(",")}async saveSampledDataToCache(){let e=(await this.uploadCsvFolderToLogJson(!0)).reduce((t,a)=>(t[a.id]=a.categories,t),{});await q.setItem(mt,e,void 0,T)}async uploadCsvFolderToLogJson(e){let t=(await Me(e)).flatMap(r=>r).filter(Boolean);console.log(t);let a=this.groupAndRankTopCategoryWithRatio(t,["mood","genre"],"id");return console.log(a),a}groupAndRankTopCategoryWithRatio(e,t,a="title"){let r={};return e.forEach(i=>{let s=i[a];r[s]||(r[s]=[]),r[s].push(i)}),Object.entries(r).map(([i,s])=>{let o=s.length,n={};for(let l of t){let c={};for(let y of s){let d=y[l];c[d]=(c[d]||0)+1}let p=Object.entries(c).sort((y,d)=>d[1]-y[1])[0];if(p){let[y,d]=p;n[l]={value:y,rank:`${d}/${o}`}}}return{[a]:i,categories:n}})}};P([U({ttl:T}),I(0,A),I(1,E)],N.prototype,"getPlayCountByArtist",1),P([_e({ttl:T}),I(0,A),I(1,E)],N.prototype,"getPlayCountByAlbum",1);var ut=class{spotifyTrackPlaylistService=u(C);spotifyPlayerService=u(te);spotifyDataService=u(N);async prepareTracks(e,t,a,r,i,s){let o=await this.spotifyTrackPlaylistService.fetchTrackList(e,t),n=await this.spotifyPlayerService.fetchCurrentUserPlayback(),l=await this.spotifyPlayerService.fetchRecentTracks(),c=[...o];if(this.spotifyTrackPlaylistService.updateCurrentTrack(c,n),this.spotifyTrackPlaylistService._updateRecentlyPlayedTracks(c,l),this.spotifyTrackPlaylistService._markDuplicates(c),a){let y=c.filter(m=>!m.playlistName?.startsWith("Sorted_On_")),d=await this.spotifyDataService.fetchViewCount(y,!1,!1);c.forEach(m=>m.playCount=d[m.trackId]||0)}let p=r.map(y=>{let d=[...new Set(c.map(S=>S[y]))].filter(Boolean),m=s.find(S=>S.property===y);return{property:y,label:y,items:d.sort((S,x)=>String(S).localeCompare(String(x))),selectedValues:m?.selectedValues||[],isMultitple:!0,strictFilter:m?.strictFilter||!1}});return{tracksInMemory:c,dropdownFilterList:p}}};var ae=class{spotifyTrackPlaylistService=u(C);applyFiltersAndSort(e,t,a,r,i,s){let o=a?.toLowerCase()||"";return[...e.filter(n=>t.every(l=>{let c=n[l.property];return c===void 0?l.selectedValues.length===0:l.selectedValues.length===0||l.selectedValues.includes(c.toString())})&&(!o||r.some(l=>{let c=n[l];return typeof c=="string"?c.toLowerCase().includes(o):!1})))].sort((n,l)=>{let c=n[i]??"",p=l[i]??"",y=typeof c=="number"&&typeof p=="number"?c-p:c instanceof Date&&p instanceof Date?c.getTime()-p.getTime():String(c).localeCompare(String(p));return s?-y:y})}async getAvailablePlaylists(e=!0){return(await this.spotifyTrackPlaylistService.fetchUserPlaylists(e)).map(t=>({playlistId:t.id,playlistName:t.name,playlistSnapshotId:t.snapshot_id,playlistLength:t.tracks.total}))}async prepareDuplicatePlaylistData(e,t){let a=new Map,r=[],i=await this.spotifyTrackPlaylistService.fetchPlaylistWithAllTracks(t,!0),s=i[0]?.playlistName;for(let l of i){let c=e.find(p=>this.spotifyTrackPlaylistService.filterCondition(p,l));if(c){let p=c.playlistName,y=a.get(p);a.set(p,{playlistName:p,trackIds:[c.uri,...y?.trackIds||[]]})}else r.push(l.uri)}let o={playlistName:s,playlistId:i[0]?.playlistId,trackIds:r,checked:!0},n=this.generateNewPlaylistNameForDuplicate(e,s);return{newTracks:o,existingTracks:a,newPlaylistName:n}}generateNewPlaylistNameForDuplicate(e,t){let a=[...new Set(e.map(r=>r.playlistName))].sort().reverse().find(r=>r.toLowerCase().includes(t.toLowerCase()));if(a){let r=a.split("#");return`${r[0]}#${Number(r[1]||1)+1}`}return`${t}#2`}};var ht=class{spotifyTrackPlaylistService=u(C);spotifyDataService=u(N);spotifyUIService=u(ae);async executeTrackOperation(e,t){if(!e?.length)return{success:!1,message:"No tracks selected."};switch(t){case"Promote (Direct)":case"Demote (Direct)":return this.changeTrackPlaylistRank(e,t);case"Move to Top":case"Move to Bottom":return this.moveTrackToExtremity(e[0],e.length,t);case"Delete Selected":return this.spotifyTrackPlaylistService.batchDeletePlaylistTracks(e);case"Like":return this.spotifyTrackPlaylistService.saveUserTracks(e.map(a=>a.trackId).filter(a=>!!a));case"Save":return this.spotifyTrackPlaylistService.addTracksToPlaylist(e.map(a=>a.uri).filter(a=>!!a),e[0].playlistId);default:throw new Error(`Operation ${t} not implemented in service.`)}}async moveTrackToExtremity(e,t,a){let r=a==="Move to Top"?1:e.playlistLength||1,i=await this.spotifyTrackPlaylistService.reorderPlaylistTracks(e,r,t);return{playlistId:e.playlistId,snapshot_id:i.snapshot_id}}async changeTrackPlaylistRank(e,t){let a=[],r=this.spotifyTrackPlaylistService.groupTracksBy(e,s=>s.playlistName),i=(await this.spotifyTrackPlaylistService.fetchUserPlaylists(!0)).map(s=>this.spotifyTrackPlaylistService.mapRawPlaylistResponse(s)).filter(s=>s.owner);for(let[s,o]of r.entries()){let{currentRank:n,baseName:l}=this.spotifyTrackPlaylistService.parsePlaylistName(s);if(t==="Promote (Direct)"&&n===1)throw new Error(`Cannot promote from "${s}": Already at the highest rank (1).`);let c=i.filter(m=>m.playlistName.startsWith(l)).map(m=>{let S=m.playlistName.match(/^(.*?)(?:#(\d+))?$/);return w(f({},m),{rank:Number(S?.[2]||1)})}).sort((m,S)=>m.rank-S.rank),p=t==="Promote (Direct)"?[...c].reverse().find(m=>m.rank<n):c.find(m=>m.rank>n);if(!p){let m=n+(t==="Promote (Direct)"?-1:1),S=`${l} #${m}`,x=await this.spotifyTrackPlaylistService.createUserPlaylist(S);p=this.spotifyTrackPlaylistService.mapRawPlaylistResponse(x),i.push(p)}let y=t==="Demote (Direct)"?0:p.playlistLength||0,d=await this.spotifyTrackPlaylistService.moveTracks(o,p.playlistId,y);a=[...a,...d]}return Array.from(new Map(a.map(s=>[s.playlistId+s.snapshot_id,s])).values())}async createDuplicatePlaylist(e){let t=e.newTracks?.trackIds||[];if(e.existingTracks.forEach(r=>{r.checked&&(t=[...t,...r.trackIds])}),!t.length)throw new Error("No Track IDs to add");let a=e.newPlaylist?(await this.spotifyTrackPlaylistService.createUserPlaylist(e.newPlaylistName)).id:e.selectedPlaylistId;for(let r of G(t,100))await this.spotifyTrackPlaylistService.addTracksToPlaylist(r,a);return a}async getSortedPlaylistData(e,t,a,r,i,s){let o=t.map(d=>d.playlistId),n=e.filter(d=>o.includes(d.playlistId)),l=Array.from(new Set(n.map(d=>a==="Album"?d.albumId:a==="Artist"?d.artistId:d.playlistId)));l=Array.from(new Set(l.flatMap(d=>d?.toString().split(",")||[])));let c=[];if(a==="PlayList"){let d=new Map;n.forEach(m=>{d.has(m.playlistId)||d.set(m.playlistId,[]),d.get(m.playlistId).push(w(f({},m),{owner:!0}))});for(let[m,S]of d.entries()){let x=t.find(j=>j.playlistId===m);c.push({name:x?.playlistName||m,tracks:S})}}else if(a==="Album")for(let d of l){let m=await this.spotifyDataService.getPlayCountByAlbum(d,!1);c.push({name:m.data.name,tracks:m.data.discs.flatMap(S=>S.tracks.map(x=>({playCount:x.playcount,trackId:x.uri.replace("spotify:track:",""),trackName:x.name,albumId:m.data.uri.replace("spotify:album:",""),albumName:m.data.name,artistId:x.artists.map(j=>j.uri.replace("spotify:artist:","")).join(","),artistName:x.artists.map(j=>j.name).join(","),owner:!0,albumImage:m.data.cover.uri})))})}else if(a==="Artist")for(let d of l){let m=await this.spotifyDataService.getPlayCountByArtist(d,!1);c.push({name:m.data.info.name,tracks:m.data.top_tracks.tracks.map(S=>({playCount:S.playcount,trackId:S.uri.replace("spotify:track:",""),trackName:S.name,albumId:S.release.uri.replace("spotify:album:",""),albumName:S.release.name,artistId:m.data.info.uri.replace("spotify:artist:",""),artistName:m.data.info.name,owner:!0,albumImage:S.release.cover.uri}))})}let p=c.reduce((d,m)=>d+m.tracks.length,0),y=this.generatePlaylistNameForSort(a,r,i,s,t);return{newTracks:c,newTracksLength:p,newPlaylistName:y}}generatePlaylistNameForSort(e,t,a,r,i){return["Sorted","On",new Date().toISOString().replace(new RegExp("-","g"),"").replace("T","").slice(0,8),"By",e,t?"T"+r:"",t?"":"S"+a,i.length===1?i[0].playlistName.replace(/#/g,""):"","#2"].filter(Boolean).join("_")}async createSortedPlaylist(e,t,a,r){let i=e.flatMap(n=>n.tracks).filter((n,l,c)=>l===c.findIndex(p=>this.spotifyTrackPlaylistService.filterCondition(n,p))),s=Array.from(new Set(i.map(n=>n.trackId)));if(!s.length)throw new Error("No track ids to add");let o=t?(await this.spotifyTrackPlaylistService.createUserPlaylist(a)).id:r;for(let n of G(s,100))await this.spotifyTrackPlaylistService.addTracksToPlaylist(n,o);return o}};var $e=(e=>(e.Promote="Promoted",e.Demote="Demoted",e.MoveToTop="Moved to top",e.MoveToBottom="Moved to bottom",e.Reorder="Reordered",e.MoveBetweenPlaylists="Moved between playlists",e.DeleteSelected="Deleted",e.SwapSongs="Swapped",e.Like="Liked",e.Add="Saved",e))($e||{}),Ne=(e=>(e.Promote="promote",e.Demote="demote",e.MoveToTop="top",e.MoveToBottom="bottom",e.DeleteSelected="delete",e.Like="like",e.Add="add",e))(Ne||{}),Oe=(e=>(e.Promote="Promote (Direct)",e.Demote="Demote (Direct)",e.MoveToTopQuick="Move to Top (Direct)",e.MoveToBottomQuick="Move to Bottom (Direct)",e.MoveToTop="Move to Top",e.Reorder="Reorder",e.MoveToBottom="Move to Bottom",e.MoveBetweenPlaylists="Add/Move Songs",e.DeleteSelected="Delete Selected",e.SwapSongs="Swap",e.Like="Like",e.Add="Save",e))(Oe||{});var Ue=class{BASE_URL="https://api.mistral.ai/v1";async chat(e,t,a){let r={Authorization:`Bearer ${t.apiKeys.mistral}`,"Content-Type":"application/json"},i={model:t.model.name,messages:e.map(s=>({role:s.role,content:s.text})),temperature:t.temperature,top_p:t.topP,max_tokens:4096};try{let s=await fetch(`${this.BASE_URL}/chat/completions`,{method:"POST",headers:r,body:JSON.stringify(i)});if(!s.ok){let n=await s.json();throw console.error("Error from Mistral API:",n),new Error(`Mistral API error: ${s.statusText}`)}let o=await s.json();return{chat:[],message:o.choices[0].message.content}}catch(s){throw console.error("Error in Mistral chat:",s),s}}async getModelList(e){let t={Authorization:`Bearer ${e.apiKeys.mistral}`};try{let a=await fetch(`${this.BASE_URL}/models`,{method:"GET",headers:t});if(!a.ok){let r=await a.json();throw console.error("Error from Mistral API:",r),new Error(`Mistral API error: ${a.statusText}`)}return(await a.json()).data}catch(a){throw console.error("Error fetching Mistral models:",a),a}}};var qe=class{BASE_URL="https://openrouter.ai/api/v1";async chat(e,t,a){let r={Authorization:`Bearer ${t.apiKeys.openrouter}`,"Content-Type":"application/json"},i={model:t.model.name,messages:e.map(s=>({role:s.role,content:s.text})),temperature:t.temperature,top_p:t.topP,n:t.n};try{let s=await fetch(`${this.BASE_URL}/chat/completions`,{method:"POST",headers:r,body:JSON.stringify(i)});if(!s.ok){let n=await s.json();throw console.error("Error from OpenRouter API:",n),new Error(`OpenRouter API error: ${s.statusText}`)}let o=await s.json();return{chat:[],message:o.choices[0].message.content}}catch(s){throw console.error("Error in OpenRouter chat:",s),s}}async getModelList(e){let t={Authorization:`Bearer ${e.apiKeys.openrouter}`};try{let a=await fetch(`${this.BASE_URL}/models`,{method:"GET",headers:t});if(!a.ok){let r=await a.json();throw console.error("Error from OpenRouter API:",r),new Error(`OpenRouter API error: ${a.statusText}`)}return(await a.json()).data}catch(a){throw console.error("Error fetching OpenRouter models:",a),a}}};var F=class{async makeRequest(e,t,a,r,i){try{let s=await fetch(`${e}`,{method:t,headers:a,body:r?JSON.stringify(r):void 0});if(!s.ok){let n=await s.json();throw n=n.error||n,new Error(`API error: ${n.message||s.statusText}`)}let o=await s.json();return(o.choices.length>1||o.candidates.length>1)&&console.error("There are multiple choices in the response:",o),{chat:[],message:o.choices[0]?.message?.content||o.candidates[0]?.content.parts.map(n=>n.text).join(" ")}}catch(s){throw console.error("Error in API request:",s),s}}};var yt="https://codestral.mistral.ai/v1",Fe=class extends F{constructor(){super()}async chat(e,t,a){let r={Authorization:`Bearer ${t.apiKeys.codestral}`,"Content-Type":"application/json"},i={model:t.model.name,messages:e.map(s=>({role:s.role,content:s.text})),temperature:t.temperature,top_p:t.topP,max_tokens:t.maxOutputTokens};return this.makeRequest(yt+"/chat/completions","POST",r,i)}async getModelList(e){console.warn("Using Mistral API to fetch models for Codestral.");let t={Authorization:`Bearer ${e.apiKeys.mistral}`};return this.makeRequest("https://api.mistral.ai/v1/models","GET",t)}};var ft="https://models.inference.ai.azure.com",je=class extends F{constructor(){super()}async chat(e,t,a){let r={"Content-Type":"application/json",Authorization:`Bearer ${t.apiKeys.github}`},i={messages:e.map(s=>({role:s.role,content:s.text})),model:t.model.name,top_p:t.useConfig?t.topP:1};return this.makeRequest(ft+"/chat/completions","POST",r,i)}async getModelList(e){let t="https://github.com/marketplace/models",a={Accept:"application/json","Accept-Language":"en-US,en;q=0.9,en-CA;q=0.8,en-IN;q=0.7","Cache-Control":"no-cache","Content-Type":"application/json"};try{let r=await fetch(t,{method:"GET",headers:a});if(!r.ok){let i=await r.text();return console.error(`Error: ${r.status} - ${i}`),{message:`Error: ${r.status} - ${i}`}}return await r.json()}catch(r){return console.error("Error fetching model list:",r),{message:"An unexpected error occurred while fetching the model list."}}}};var ze=class{getModelList(e){throw new Error("Method not implemented.")}clientId="Iv1.b507a08c87ecfe98";userAgent="GithubCopilot/1.155.0";orgExtension="true";async setup(){return this.postJson("https://github.com/login/device/code",{client_id:this.clientId,scope:"read:user"})}async continueSetup(e){let t=await this.postJson("https://github.com/login/oauth/access_token",{client_id:this.clientId,device_code:e,grant_type:"urn:ietf:params:oauth:grant-type:device_code"}),{access_token:a,expires_in:r=31536e6,error_description:i}=t;if(i)throw new Error(i);if(a){let s=Date.now()+r*1e3;this.saveToken("copilot_access_token",a,s),console.log("Authentication successful!")}}saveToken(e,t,a){localStorage.setItem(e,JSON.stringify({token:t,expiration:a}))}loadToken(e){let t=localStorage.getItem(e);if(!t)return null;let{token:a,expiration:r}=JSON.parse(t);return Date.now()>r?(localStorage.removeItem(e),null):a}async getAccessToken(e){let t=this.loadToken("copilot_access_token");if(!t){let a=await this.setup();if(await e(a))await this.continueSetup(a.device_code),t=this.loadToken("copilot_access_token");else throw new Error("User denied access")}return t}async getSessionToken(e){let t=await this.getAccessToken(e);if(!t)throw new Error("Access token not available");let a=await fetch("https://api.github.com/copilot_internal/v2/token",{method:"GET",headers:{Authorization:`token ${t}`,"User-Agent":this.userAgent,"my-org-extension":this.orgExtension}});await this.validateResponse(a);let{token:r,expires_at:i}=await a.json();if(!r||!i)throw new Error("Token not found");let s=(i-10)*1e3;return this.saveToken("copilot_session_token",r,s),r}async getToken(e){let t=this.loadToken("copilot_session_token");return t||(t=await this.getSessionToken(e)),t}async copilot(e,t="javascript",a){let r=await this.getToken(a),i="";try{let s=await fetch("https://copilot-proxy.githubusercontent.com/v1/engines/copilot-codex/completions",{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json","my-org-extension":this.orgExtension},body:JSON.stringify({prompt:`${e}
`,suffix:"",max_tokens:1e3,temperature:0,top_p:1,n:1,stop:[`
`],nwo:"github/copilot.vim",stream:!0,extra:{language:t}})});if(!s.body)throw new Error("Response body is null");let o=s.body.getReader(),n=new TextDecoder,l="";for(;;){let{done:c,value:p}=await o.read();if(c)break;let y=n.decode(p,{stream:!0}).split(`
`);for(let d of y)if(l&&(d=l+d,l=""),d.startsWith("data: {"))try{let m=JSON.parse(d.slice(6)).choices[0].text||"";console.log(m),i+=m}catch(m){console.error("Error parsing JSON:",m)}else l=d}if(l.startsWith("data: {"))try{let c=JSON.parse(l.slice(6)).choices[0].text||"";console.log(c),i+=c}catch(c){console.error("Error parsing JSON:",c)}}catch(s){console.error("Connection error:",s)}return console.log("FinalResult",i),i}async chat(e,t,a){let r=e.map(i=>({content:i.text,role:i.role==="user"?"user":"assistant"}));return this.commonGitHubChat(r,t,a)}async commonGitHubChat(e,t,a){let r=await this.getToken(a),i=await fetch("https://api.githubcopilot.com/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${r}`,"Editor-Version":"vscode/1.80.1","Content-Type":"application/json","my-org-extension":this.orgExtension},body:JSON.stringify({intent:!1,model:t.model.name,temperature:t.useConfig?t.temperature:0,top_p:t.useConfig?t.topP:1,n:t.useConfig?t.n:1,messages:e})});if(i.status===401)throw localStorage.removeItem("copilot_session_token"),new Error("Unauthorized");let s={chat:[],message:""};if(i.status===429){let l=parseInt(i.headers.get("x-ratelimit-user-retry-after")||"86400")*1e3,c=Date.now()+l;return s.retryAfter={status:429,message:`Rate limit exceeded. Please try again after ${new Date(c).toLocaleString()}.`,retryAfter:l},s}await this.validateResponse(i);let{choices:o}=await i.json();o.length>1&&console.error("There are multiple choices in the response:",o);let n=o[0].message.content;return{chat:[],message:n}}async postJson(e,t,a={}){let r=await fetch(e,{method:"POST",headers:f({Accept:"application/json","Content-Type":"application/json","User-Agent":this.userAgent,"my-org-extension":this.orgExtension},a),body:JSON.stringify(t)});return await this.validateResponse(r),r.json()}async validateResponse(e){if(!e.ok){let t="";try{t=await e.json()}catch{}throw new Error(JSON.stringify(t)||e.statusText)}}};var Be=class{BASE_URL="https://generativelanguage.googleapis.com/v1beta/models";async chat(e,t,a){let r=t.apiKeys.google,i=t.model.name,s={contents:e.map(o=>({role:o.role==="assistant"?"model":"user",parts:[{text:o.text}]})),generationConfig:{temperature:t.useConfig?t.temperature:1,topK:t.useConfig?t.topK:64,topP:t.useConfig?t.topP:.95,maxOutputTokens:t.maxOutputTokens,responseMimeType:"text/plain"}};try{let o=await fetch(`${this.BASE_URL}/${i}:generateContent?key=${r}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!o.ok){let l=await o.json();throw l=l.error||l,new Error(`Google Gemini API error: ${l.message||o.statusText}`)}let n=await o.json();return n.candidates.length>1&&console.error("There are multiple choices in the response:",n),{chat:[],message:n.candidates[0].content.parts.map(l=>l.text).join(" ")}}catch(o){throw console.error("Error in Google Gemini chat:",o),o}}async getModelList(e){let t=e.apiKeys.google;try{let a=await fetch(`${this.BASE_URL}?key=${t}`,{method:"GET"});if(!a.ok){let r=await a.json();throw console.error("Error from Google Gemini API:",r),new Error(`Google Gemini API error: ${a.statusText}`)}return(await a.json()).models}catch(a){throw console.error("Error fetching Google Gemini models:",a),a}}};var Ge=class{BASE_URL="https://api.groq.com/openai/v1";async chat(e,t,a){let r={Authorization:`Bearer ${t.apiKeys.qroq}`,"Content-Type":"application/json"},i={model:t.model.name,messages:e.map(s=>({role:s.role,content:s.text})),temperature:t.temperature,top_p:t.topP,n:t.n};try{let s=await fetch(`${this.BASE_URL}/chat/completions`,{method:"POST",headers:r,body:JSON.stringify(i)});if(!s.ok){let n=await s.json();throw console.error("Error from Qroq API:",n),new Error(`Qroq API error: ${s.statusText}`)}let o=await s.json();return{chat:[],message:o.choices[0].message.content}}catch(s){throw console.error("Error in Qroq chat:",s),s}}async getModelList(e){let t={Authorization:`Bearer ${e.apiKeys.qroq}`};try{let a=await fetch(`${this.BASE_URL}/models`,{method:"GET",headers:t});if(!a.ok){let r=await a.json();throw console.error("Error from Qroq API:",r),new Error(`Qroq API error: ${a.statusText}`)}return(await a.json()).data}catch(a){throw console.error("Error fetching Qroq models:",a),a}}};var gt="https://api.anthropic.com/v1",Ke=class extends F{constructor(){super()}async chat(e,t,a){let r={"x-api-key":t.apiKeys.claude,"anthropic-version":"2023-06-01","Content-Type":"application/json"},i={model:t.model.name,messages:e.map(s=>({role:s.role,content:s.text})),max_tokens:t.maxOutputTokens,temperature:t.temperature,top_p:t.topP,system:"assistant"};return this.makeRequest(gt+"/messages","POST",r,i)}async getModelList(e){return console.warn("Anthropic Claude does not have a model list endpoint. Returning a predefined list."),[{name:"claude-3-opus-20240229"},{name:"claude-3-sonnet-20240229"},{name:"claude-3-haiku-20240307"},{name:"claude-2.1"},{name:"claude-2.0"},{name:"claude-instant-1.2"}]}};var re=class{services=new Map([["Gemini",new Be],["GithubModels",new je],["GithubVsc",new ze],["AnthropicClaude",new Ke],["Codestral",new Fe],["Mistral",new Ue],["OpenRouter",new qe],["Groq",new Ge]]);async getAIService(e){let t=this.resolveModel(e),a=this.services.get(t.org);if(!a)throw new Error(`Service not found for ${t.org}`);return a}loadModels(e){let t={Gemini:["gemini-2.5-flash-preview-04-17","gemini-2.0-flash-lite-001","gemini-2.0-flash-lite","gemini-2.5-pro-preview-05-06","gemini-2.5-pro-preview-03-25","gemini-2.0-flash","gemini-2.0-flash-preview-image-generation","gemini-2.0-pro-exp-02-05","gemini-exp-1206","gemini-2.0-flash-thinking-exp-1219","gemini-2.0-flash-exp","gemini-1.5-pro-latest","gemini-1.5-pro-002","gemini-1.5-pro","gemini-1.5-flash","gemini-1.0-pro-latest","gemini-1.0-pro","gemini-1.5-flash-8b","learnlm-1.5-pro-experimental","gemini-exp-1114","gemini-exp-1121"],GithubVsc:["gpt-4.1","gpt-4o","o4-mini","gemini-2.5-pro","claude-3.5-sonnet","claude-3.7-sonnet","o1","o1-mini","gpt-4o-mini","gpt-4.1-mini","gpt-4.1-nano","o3","o3-mini","gpt-4.5","gpt-4-turbo"],GithubModels:["gpt-4o","gpt-4o-mini","o1-mini","o1-preview","text-embedding-3-large","text-embedding-3-small","Phi-3.5-MoE-instruct","Phi-3.5-mini-instruct","Phi-3.5-vision-instruct","Phi-3-medium-128k-instruct","Phi-3-medium-4k-instruct","Phi-3-mini-128k-instruct","Phi-3-mini-4k-instruct","Phi-3-small-128k-instruct","Phi-3-small-8k-instruct","AI21-Jamba-1.5-Large","AI21-Jamba-1.5-Mini","Cohere-command-r","Cohere-command-r-08-2024","Cohere-command-r-plus","Cohere-command-r-plus-08-2024","Cohere-embed-v3-english","Cohere-embed-v3-multilingual","Llama-3.2-11B-Vision-Instruct","Llama-3.2-90B-Vision-Instruct","Llama-3.3-70B-Instruct","Meta-Llama-3.1-405B-Instruct","Meta-Llama-3.1-70B-Instruct","Meta-Llama-3.1-8B-Instruct","Meta-Llama-3-70B-Instruct","Meta-Llama-3-8B-Instruct","Ministral-3B","Mistral-Large-2411","Mistral-Nemo","Mistral-large","Mistral-large-2407","Mistral-small","jais-30b-chat"],AnthropicClaude:["claude-3-opus-20240229","claude-3-sonnet-20240229","claude-3-haiku-20240307","claude-2.1","claude-2.0","claude-instant-1.2"],Codestral:["codestral-latest"],Mistral:["mistral-small-latest","mistral-medium-latest","mistral-large-latest"],OpenRouter:["mistralai/mistral-7b-instruct","nousresearch/nous-capybara-7b","openrouter/cinematika-7b","gryphe/mythomist-7b"],Groq:["llama2-70b-4096","mixtral-8x7b-32768"]},a=Object.entries(t).flatMap(([r,i])=>i.map(s=>({name:s,org:r})));return e.models=this.updateStoredModels(e.models,a),localStorage.setItem("settings",JSON.stringify(e)),e.models.map(r=>this.updateModelStatus(r)).sort((r,i)=>{let s=a.findIndex(n=>n.name===r.name&&n.org===r.org),o=a.findIndex(n=>n.name===i.name&&n.org===i.org);return s-o})}updateStoredModels(e,t){return t.forEach(a=>{e.some(r=>r.name===a.name&&r.org===a.org)||e.push(a)}),e.filter(a=>t.some(r=>r.name===a.name&&r.org===a.org))}updateModelStatus(e){if(e.retryAfter&&e.retryAfterCreatedAt){let t=new Date(e.retryAfterCreatedAt).getTime()+e.retryAfter*1e3;e.retryAfterDate=new Date(t).toLocaleTimeString(),e.disabled=t>Date.now()}return e}resolveModel(e){let t=this.loadModels(e).find(a=>a.name===e.model.name&&a.org===e.model.org);if(!t)throw new Error("Model not found");if(t.disabled)throw new Error(`Model is disabled. Please try again after ${t.retryAfterDate}`);return t}async message(e,t,a){return this.chat([{role:"user",text:e,date:new Date}],t,a)}async chat(e,t,a){t.maxOutputTokens??=8192*4;let r=await(await this.getAIService(t)).chat(e,t,a);return r.chat||(r.chat=[]),r.chat.push(...e,{role:"assistant",text:r.message,date:new Date}),r}};var b={FILE_START:"#FILE:",FILE_END:"#END_FILE"};var ie=`#INDENTATION: Use tabs (	) for indentation, not spaces.

#TabSize: Each tab equals 4 spaces visually.`,se=`#OUTPUT FORMAT:
Please provide the code in the following format:
${b.FILE_START}<filename>
<code>
${b.FILE_END}
Make sure there are no extra code blocks (\`\`\`) or other characters before or after the code.`,wt=["Aim to reduce the code to the minimum possible by simplifying, reducing complexity, removing redundant code while retaining functionality and clarity. Minimize the number of methods, creating common methods only if used in at least two places.","Provide meaningful and descriptive names for members and variables","Prioritize performance optimizations without sacrificing code maintainability.","Ensure the code adheres to the latest industry best practices and coding standards.","Strive for modularity and reusability in code design.","Incorporate comprehensive error handling and robust exception management.","Exclude any file that has no updates in your refactoring.","Convert array initializations and imports to one-liners where possible."],H=["Use strongly typed variables, methods, and parameters for type safety. Try to create specific types for all any types if possible, to enhance type safety and reduce implicit conversions.","Place all type definitions at the bottom of the file."],vt="empty",St=[{name:"empty",type:"Combined",excludeCommonInstructions:!0,role:"",promptTextList:[]},{name:"VanillaTSExtraction",excludeCommonInstructions:!0,type:"Combined",role:"Senior Technical Lead Engineer specializing in TypeScript",promptTextList:[{text:"Extract all Vanilla TypeScript code that has no dependencies on any other libraries into a separate file.",selected:!0},{text:"Extract/Identify/refactor common/duplicate TypeScript code into reusable code blocks",selected:!0},{text:"Create TypeScript interfaces or types for shared data structures and models.",selected:!0},{text:"Update existing code references to use the extracted utilities or interfaces.",selected:!0},...H.map(e=>({text:e,selected:!0}))]},{name:"angular",type:"Combined",role:"Senior Angular Developer specializing in Angular 19, TypeScript, and modern web development. Expert in optimizing and refactoring Angular applications for performance, scalability, and maintainability. Adept at leveraging the latest Angular features and best practices.",promptTextList:[{text:"Ensure compatibility with Angular 19 and the latest TypeScript.",selected:!0},{text:"Use Angular's new control flow syntax (e.g., @for, @if) for loops and conditional rendering.",selected:!0},{text:"Use the inject method for service injection instead of constructor injection (e.g., private readonly service = inject(Service);).",selected:!0},{text:"Leverage new Angular feature signals for DOM element selection, such as divEls = viewChildren<ElementRef>('el'); or cmp = viewChild(MyComponent, {read: ElementRef}); or modalData = input<any>();.",selected:!0},{text:"Optimize bindings and directives for performance.",selected:!0},{text:"Ensure proper use of structural directives to manage the DOM efficiently.",selected:!0},...H.map(e=>({text:e,selected:!0}))]},{name:"dotnet",type:"Combined",role:"Senior C# Developer specializing in .NET technologies with expertise in crafting modern, maintainable, and efficient software.",promptTextList:[{text:"Optimize performance by avoiding unnecessary object instantiation.",selected:!0}]},{name:"ts",type:"Individual",role:"Web Developer specializing in HTML, JavaScript, TypeScript, Angular 19, SCSS, and CSS. A quick, clever, and resourceful engineer focused on precision and near-perfection in all tasks.",promptTextList:H.map(e=>({text:e,selected:!0}))},{name:"js",type:"Individual",role:"Web Developer specializing in HTML, JavaScript, TypeScript, Angular 19, SCSS, and CSS. A quick, clever, and resourceful engineer focused on precision and near-perfection in all tasks.",promptTextList:[{text:"Ensure compatibility with modern JavaScript standards and best practices.",selected:!0}]},{name:"html",type:"Individual",role:"Web Developer specializing in HTML, JavaScript, TypeScript, Angular 19, SCSS, and CSS. A quick, clever, and resourceful engineer focused on precision and near-perfection in all tasks.",promptTextList:[{text:"Refactor the HTML code by improving structure and semantics. Ensure proper use of semantic elements for better accessibility.",selected:!0},{text:"Minimize the use of inline styles and scripts.",selected:!0},{text:"Follow best practices for responsive design and compatibility across browsers.",selected:!0}]},{name:"scss",type:"Individual",role:"Web Developer specializing in HTML, JavaScript, TypeScript, Angular 19, SCSS, and CSS. A quick, clever, and resourceful engineer focused on precision and near-perfection in all tasks.",promptTextList:[{text:"Use variables and mixins to reduce repetition.",selected:!0},{text:"Organize styles into modular components.",selected:!0},{text:"Ensure proper nesting of selectors.",selected:!0},{text:"Utilize variables instead of hard-coded values.",selected:!0}]},{name:"cs",type:"Individual",role:"Senior C# Developer specializing in .NET technologies with expertise in crafting modern, maintainable, and efficient software.",promptTextList:[]},{name:"AngularComponentRefactor",type:"Combined",role:`Senior Technical Lead Engineer specializing in Angular 19, TypeScript, and modern web development.
    Expert in optimizing and refactoring Angular applications for performance, scalability, and maintainability.
    Adept at leveraging the latest Angular features and best practices.`,promptTextList:[{text:"Refactor the Angular component code using the latest Angular 19 features, such as control flow syntax (@for, @if, @switch), deferred loading (@defer), and signals.",selected:!0},{text:"Optimize component's change detection strategy. Use OnPush where applicable and leverage signals for fine-grained reactivity.",selected:!0},{text:"Migrate to standalone components, directives, and pipes to improve modularity and reduce the reliance on NgModules.",selected:!0},{text:"Ensure optimal use of RxJS operators. Minimize subscriptions and use the async pipe where possible.",selected:!0},{text:"Refactor services to use providedIn: 'root' or other tree-shakable providers for better bundle size optimization.",selected:!0},{text:"Implement functional guards and resolvers using the inject() function for improved code readability and testability.",selected:!0},{text:"Review and optimize template structures. Minimize DOM manipulation and ensure efficient use of structural directives.",selected:!0},{text:"Ensure accessibility (a11y) best practices are followed in the component's template and logic.",selected:!1},{text:"Optimize the component's performance, including lazy loading, preloading strategies, and bundle size reduction.",selected:!0}]},{name:"TypeScriptOptimization",type:"Combined",role:`Senior Technical Lead Engineer with deep expertise in TypeScript.
    Proficient in writing clean, efficient, and type-safe code.
    Familiar with advanced TypeScript features and design patterns.`,promptTextList:[{text:"Refactor the TypeScript code to use advanced types like generics, conditional types, mapped types, and utility types (e.g., Partial, Readonly, Record, Pick) to enhance type safety and code reusability.",selected:!0},{text:"Enforce strict type checking. Eliminate implicit 'any' types and ensure all variables, function parameters, and return types are explicitly typed.",selected:!0},{text:"Leverage TypeScript's decorators to enhance class functionalities and metadata.",selected:!0},{text:"Refactor asynchronous code to use async/await for better readability and error handling. Ensure proper use of Promises and error handling mechanisms.",selected:!0},{text:"Apply design patterns such as Singleton, Factory, Observer, etc., where appropriate to improve code structure and maintainability.",selected:!0},{text:"Ensure the code is modular and follows SOLID principles. Break down large files into smaller, more manageable modules.",selected:!0},{text:"Optimize the use of enums. Consider using string enums or literal types for better type safety and debugging.",selected:!0},{text:"Document complex types and functions using JSDoc to improve code understanding and maintainability.",selected:!0},{text:"Leverage TypeScript's type inference capabilities to reduce verbosity and improve code readability.",selected:!0}]},{name:"DotNetCoreModernization",type:"Combined",role:`Senior Technical Lead Engineer specializing in .NET Core and C#.
    Expert in modernizing and optimizing .NET applications using the latest frameworks and best practices.
    Skilled in performance tuning, cloud-native development, and microservices architecture.`,promptTextList:[{text:"Refactor the C# code to use the latest language features in C# 12, such as primary constructors, collection expressions, using aliases for any type, default lambda parameters, and inline arrays.",selected:!0},{text:"Migrate the application to the latest .NET 8, taking advantage of performance improvements, new APIs, and enhanced tooling.",selected:!0},{text:"Optimize the application's startup and runtime performance. Use techniques like ahead-of-time (AOT) compilation, trimming, and startup hooks.",selected:!1},{text:"Ensure services are registered correctly in the DI container and leverage scoped, transient, and singleton lifetimes appropriately.",selected:!0},{text:"Implement asynchronous programming patterns using async and await throughout the application. Ensure proper use of Task and ValueTask for performance-critical code.",selected:!0},{text:"Implement robust logging, monitoring, and distributed tracing using Application Insights, and OpenTelemetry.",selected:!0},{text:"Ensure proper input validation and protect against common web vulnerabilities.",selected:!0}]},{name:"SQLServerOptimization",type:"Combined",excludeCommonInstructions:!0,role:`Senior Technical Lead Engineer with extensive experience in SQL Server database design, development, and optimization.
    Expert in writing efficient queries, optimizing database performance, and ensuring data integrity.
    Familiar with the latest SQL Server features and best practices.`,promptTextList:[{text:"Analyze and optimize existing SQL queries. Identify and rewrite inefficient queries, use appropriate indexing strategies, and optimize query plans.",selected:!0},{text:"Review and optimize the database schema. Ensure proper normalization, use appropriate data types, and define constraints to maintain data integrity.",selected:!0},{text:"Implement indexing strategies to improve query performance. Create clustered and non-clustered indexes, covering indexes, and filtered indexes where appropriate.",selected:!0},{text:"Optimize stored procedures and functions. Refactor complex stored procedures, use efficient T-SQL constructs, and minimize the use of cursors.",selected:!0},{text:"Stay up-to-date with the latest SQL Server features, best practices, and performance tuning techniques.",selected:!0}]},{name:"PromptEngineeringBestPractices",type:"Combined",excludeCommonInstructions:!0,role:`Senior Technical Lead Engineer specializing in prompt engineering for large language models.
    Expert in crafting effective prompts that elicit accurate, relevant, and high-quality responses.
    Familiar with various prompting techniques and strategies.`,promptTextList:[{text:"Refactor the prompt to be clear, concise, and unambiguous. Ensure the prompt provides sufficient context and instructions for the language model to understand the desired task.",selected:!0},{text:"Use appropriate prompt engineering techniques, such as few-shot learning, chain-of-thought prompting, or tree-of-thought prompting, to guide the language model's reasoning process.",selected:!0},{text:"Incorporate constraints and guidelines in the prompt to steer the language model's output towards the desired format, style, and tone.",selected:!0},{text:"Consider using prompt chaining or composition to break down complex tasks into smaller, more manageable subtasks.",selected:!0},{text:"Optimize prompts for efficiency and effectiveness, considering factors like response length, complexity, and coherence.",selected:!0}]}];var We=(e=>(e.Individual="Individual",e.Combined="Combined",e.Chat="Chat",e))(We||{});var Je=(e=>(e[e.InMemory=0]="InMemory",e[e.LocalStorage=1]="LocalStorage",e[e.SessionStorage=2]="SessionStorage",e[e.IndexedDb=3]="IndexedDb",e[e.IndexedDbSession=4]="IndexedDbSession",e[e.Firestore=5]="Firestore",e[e.OPFSSqlLite=6]="OPFSSqlLite",e[e.IndexedDbSqlite=7]="IndexedDbSqlite",e[e.WaSqlite=8]="WaSqlite",e[e.ChromeExtensionStorage=9]="ChromeExtensionStorage",e[e.LocalFileSystem=10]="LocalFileSystem",e))(Je||{}),He=(e=>(e.Gemini="Gemini",e.AnthropicClaude="AnthropicClaude",e.Codestral="Codestral",e.Mistral="Mistral",e.OpenRouter="OpenRouter",e.Groq="Groq",e.GithubVsc="GithubVsc",e.GithubModels="GithubModels",e))(He||{});var kt={apiKey:"AIzaSyDoE2UBK3TKGwW8ZIbFl-Yq5-h6zpiVPbM",authDomain:"mahindar-1.firebaseapp.com",databaseURL:"https://mahindar-1.firebaseio.com",projectId:"mahindar-1",storageBucket:"mahindar-1.appspot.com",messagingSenderId:"280446112313",appId:"1:280446112313:web:854c7107f90fdc329073e8"};var bt=class{fileService=u(Ve);aiservice=u(re);async processFiles(e,t,a,r,i){let s=a.processingStrategy;switch(a.selectedPrompt.name!="empty"&&(t=`${t}

${ie}

${se}`),s){case"Individual":await this.processFilesIndividually(e,t,a,r,i);break;case"Combined":await this.processFilesCombined(e,t,a,r,i);break;case"Chat":await this.processFilesChat(e,t,a,r,i);break}}async processFilesIndividually(e,t,a,r,i){for(let s of e)try{let o=await this.fileService.getFileContent(s),n=`${t}

${s.handle.name}

${o}`;i(s,"inprogress","","");let l=await this.aiservice.message(n,a,r);this.processResponse(l,a);let c=this.fileService.extractCode(l.message);i(s,"done",c,""),await this.fileService.writeToFile(w(f({},s),{code:c}))}catch(o){console.error(o),e.forEach(n=>{i(n,"error","",o.message)})}}async processFilesCombined(e,t,a,r,i){try{let s="";for await(let l of e){let c=await this.fileService.getFileContent(l);s+=`${b.FILE_START}${l.path}
\`\`\`
${c}
\`\`\`
${b.FILE_END}

`,i(l,"inprogress","","")}let o=`${t}

${s}`,n=await this.aiservice.message(o,a,r);this.processResponse(n,a),await this.extractFilesText(n.message,e,i)}catch(s){console.error(s),e.forEach(o=>{i(o,"error","",s.message)})}}async processFilesChat(e,t,a,r,i){try{for(let s of e){let o=`#Context:
`;for await(let y of e){let d=await this.fileService.getFileContent(y);o+=`${b.FILE_START}${y.path}
\`\`\`
${d}
\`\`\`
${b.FILE_END}

`}let n=await this.fileService.getFileContent(s),l=`${t}

                Process the below single file with above context

                
${b.FILE_START}${s.path}
\`\`\`
${n}
\`\`\`
${b.FILE_END}

`,c=await this.aiservice.chat([{role:"user",text:o,date:new Date},{role:"user",text:l,date:new Date}],a,r);this.processResponse(c,a);let p=this.fileService.extractCode(c.message);i(s,"done",p,""),await this.fileService.writeToFile(w(f({},s),{code:p}))}}catch(s){console.error(s),e.forEach(o=>{i(o,"error","",s.message)})}}processResponse(e,t){if(e.retryAfter){let a=t.models.find(r=>r.name===t.model.name&&r.org===t.model.org);throw a&&(a.retryAfter=e.retryAfter.retryAfter,a.retryAfterCreatedAt=new Date().toISOString()),new Error("Rate limit exceeded. Please try again later.")}}async extractFilesText(e,t,a){let r=new RegExp(`${b.FILE_START}(.+?)
([\\s\\S]*?)${b.FILE_END}`,"g"),i;for(window.combinedMessage=e;(i=r.exec(e))!==null;){let s=i[1].trim(),o=t.find(n=>n.path===s);try{let n=this.fileService.extractCode(i[2].trim());o?(a(o,"done",n,""),this.fileService.writeToFile(w(f({},o),{code:n}))):await this.createNewFile(s,n,t,a)}catch(n){o&&a(o,"error","",n.message)}}}async createNewFile(e,t,a,r){let i=e.split("/").slice(-2,-1)[0],s=a.find(n=>n.directoryHandle?.name==i)?.directoryHandle,o={path:e,status:"done",code:t,selected:!1};if(s){let n=await s.getFileHandle(e.split("/").pop(),{create:!0});o.handle=n,o.directoryHandle=s,this.fileService.writeToFile(w(f({},o),{code:t})),r(o,"done","",t),console.log(`File created for ${e}`)}else console.error(`Directory not found for ${e}`),r(o,"error",t,`Directory not found for ${e}`)}},Ve=class{async getFileContent(e){return await(await e.handle.getFile()).text()}async writeToFile(e){if(!e.handle)throw new Error("File handle is missing for path: "+e.path);let t=await e.handle.createWritable();await t.write(e.code||""),await t.close()}async saveFileAs(e){let t=await window.showSaveFilePicker({suggestedName:e.path.split("/").pop(),id:"ai-agent",startIn:e.directoryHandle}),a=w(f({},e),{handle:t,path:t.name});return await this.writeToFile(a),a}async getFilesFromDirectory(e,t){let a=[];for await(let[r,i]of e){let s=`${t}/${r}`;if(i.kind==="file")await this.requestPermission(i),a.push({handle:i,path:s,directoryHandle:e});else if(i.kind==="directory"){if(["node_modules",".git","dist","build","bin","obj","out","target"].includes(r))continue;let o=await this.getFilesFromDirectory(i,s);a.push(...o)}}return a}async requestPermission(e){if(await e.requestPermission({mode:"readwrite"})!=="granted")throw new Error("Write permissions not granted")}extractCode2(e){return e.replace(/^```.*\n/,"").replace(/```$/,"").trim()}extractCode(e){let t=e.indexOf("```");if(t===-1)return this.extractCode2(e);let a=e.indexOf(`
`,t);if(a===-1)return this.extractCode2(e);let r=e.indexOf("```",a+1);return r===-1?this.extractCode2(e):e.substring(a+1,r)}updateFileList(e,t){return e.type==="Combined"?t:t.filter(a=>a.path.split(".").pop()===e.name)}async handleDrop(e){e.preventDefault();let t=e.dataTransfer?.items??[],a=[],r=Array.from(t).map(s=>({kind:s.kind,type:s.type,getAsFileSystemHandle:s.getAsFileSystemHandle.bind(s)})).map(async s=>{if(s.kind==="file"){let o=await s.getAsFileSystemHandle();return o?o.kind==="directory"?await this.getFilesFromDirectory(o,o.name):(await this.requestPermission(o),{handle:o,path:o.name,directoryHandle:void 0}):(console.error("File handle not found"),null)}return null}),i=await Promise.all(r);return a=a.concat(...i.filter(s=>s!==null)),a}async selectFolder(){let e=await window.showDirectoryPicker({id:"ai-agent"});return this.getFilesFromDirectory(e,e.name)}async selectFiles(){let e=await window.showOpenFilePicker({multiple:!0,id:"ai-agent"}),t=[];for(let a of e)await this.requestPermission(a),t.push({handle:a,path:a.name,directoryHandle:void 0});return t}};var xt={namespace:"@mahindar5/common-lib",version:"1.2.147",commit:"621bd7ed60d00b60091dda38d115279542709b2d",branch:"main",lastCommitMessage:"Merge branch 'main' of https://github.com/mahindar5/common-lib",lastCommitAuthor:"mahindar5",lastCommitDate:"2025-08-05 18:29:28 -0700",buildNumber:"1754443792372",buildId:"build-1754443792372",buildUrl:"",buildEnvironment:"development",buildHost:"pkrvmjbmru5nbw0",buildTarget:"development",nodeVersion:"v22.17.1",npmVersion:"10.9.2",os:"linux",arch:"x64",buildDate:"8/6/2025",buildTime:"1:29:52 AM",timestamp:"2025-08-06T01:29:52.354Z"};export{u as a,z as b,Ye as c,A as d,O as e,T as f,he as g,g as h,Ze as i,Q as j,Xe as k,Z as l,ye as m,X as n,rt as o,C as p,te as q,N as r,ut as s,ae as t,ht as u,$e as v,Ne as w,Oe as x,kt as y,re as z,wt as A,vt as B,St as C,bt as D,Ve as E,We as F,He as G,xt as H};
